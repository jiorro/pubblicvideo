<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Canaan & Jiorro Video ‚Äî Extended</title>
  <style>
    /* -----------------------------------------
       Theme / Reset
       ----------------------------------------- */
    :root{
      --bg:#0f0f10; --panel:#18181b; --border:#2a2a31; --text:#fff;
      --muted:#b7b7c3; --accent:#6ff66f; --brand:#66aaff; --danger:#ff6666;
      --warn:#f3c969; --shadow:rgba(0,0,0,0.35);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    *,*:before,*:after{box-sizing:border-box}
    a{color:inherit}

    /* -----------------------------------------
       Topbar + lens
       ----------------------------------------- */
    .topbar{
      position:fixed;top:0;left:0;right:0;height:64px;padding:0 18px;
      display:flex;align-items:center;justify-content:flex-end;
      background:linear-gradient(to bottom, rgba(24,24,27,0.95), rgba(24,24,27,0.7));
      border-bottom:1px solid var(--border);z-index:1000;backdrop-filter:blur(6px);
    }
    .lens-btn{
      width:46px;height:46px;border-radius:12px;border:1px solid var(--border);
      background:var(--panel);color:var(--text);font-size:20px;display:inline-flex;
      align-items:center;justify-content:center;cursor:pointer;transition:all .12s;
    }
    .lens-btn:hover{transform:translateY(-2px);box-shadow:0 12px 32px var(--shadow);border-color:var(--brand);color:var(--accent)}

    .status{
      position:fixed;top:72px;right:18px;font-size:13px;color:var(--muted);z-index:950;text-align:right;
    }
    .status.success{color:var(--accent)} .status.error{color:var(--danger)}

    /* -----------------------------------------
       Layout sections
       ----------------------------------------- */
    .section{padding-top:96px;min-height:100vh;transition:opacity .22s,visibility .22s}
    .hidden{opacity:0;visibility:hidden;pointer-events:none}

    .home-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;padding:28px}
    .panel{
      background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;
      box-shadow:0 14px 36px var(--shadow);
    }

    .home-figure{display:flex;align-items:center;justify-content:center;padding:12px;border-radius:12px}
    .home-figure img{max-width:100%;border-radius:10px;border:1px solid var(--border)}

    /* -----------------------------------------
       Video area
       ----------------------------------------- */
    .video-container{padding:28px;display:grid;gap:16px}
    .video-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px;border-radius:12px}
    .btn{
      background:var(--panel);border:1px solid var(--border);color:var(--text);
      padding:9px 12px;border-radius:10px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;
    }
    .btn:hover{transform:translateY(-2px);border-color:var(--brand)}
    .input{background:var(--panel);border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text)}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:12px;display:flex;flex-direction:column;gap:8px}
    .card video{width:100%;border-radius:8px;background:black}
    .title{font-weight:600} .views{color:var(--muted);font-size:13px}

    /* -----------------------------------------
       Modal
       ----------------------------------------- */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    .modal.show{display:flex}
    .modal-panel{width:92%;max-width:640px;background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:12px;box-shadow:0 14px 44px var(--shadow)}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .status-line{margin-top:8px;color:var(--muted);min-height:18px}
    .status-line.success{color:var(--accent)} .status-line.error{color:var(--danger)}

    /* -----------------------------------------
       Admin bottom-left discreet anchor + input
       ----------------------------------------- */
    .admin-anchor{position:fixed;left:14px;bottom:14px;z-index:1300;display:flex;flex-direction:column;align-items:flex-start;gap:8px}
    .admin-btn{width:46px;height:46px;border-radius:999px;background:var(--panel);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;color:var(--text);font-size:18px;cursor:pointer;transition:transform .12s}
    .admin-btn:hover{transform:translateY(-2px);border-color:var(--brand);color:var(--brand)}
    .admin-input-wrap{display:none;gap:8px;align-items:center}
    .admin-input{width:220px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none}

    /* -----------------------------------------
       Admin panel
       ----------------------------------------- */
    .admin-section{padding:26px}
    .admin-panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
    .admin-grid{width:100%;border-collapse:collapse;margin-top:12px}
    .admin-grid th,.admin-grid td{padding:10px;border-top:1px solid var(--border);vertical-align:middle}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202025;color:var(--muted);border:1px solid var(--border);font-size:13px}
    .pill.pub{background:#103016;color:var(--accent);border-color:#244b2f}
    .actions{display:flex;gap:8px;flex-wrap:wrap} .danger{color:var(--danger)}

    @media (max-width:980px){.home-grid{grid-template-columns:1fr}.admin-input{width:150px}}
  </style>
</head>
<body>

  <!-- Top bar with lens -->
  <header class="topbar" role="banner">
    <button id="lensBtn" class="lens-btn" aria-label="Apri sezione video">üîç</button>
  </header>
  <div id="statusEl" class="status" aria-live="polite"></div>

  <!-- HOME -->
  <main id="homeSection" class="section">
    <div class="home-grid">
      <article class="panel">
        <h1>La regione di Canaan</h1>
        <p>La regione di Canaan (o Cananea) si trovava nel Levante e corrisponde approssimativamente ai territori degli attuali Libano, Israele, Palestina e parti della Siria e della Giordania. In questa area geografica si svilupparono sia la civilt√† dei Fenici che quella degli Ebrei.</p>
        <p><strong>Fenici:</strong> insediati lungo la costa; citt√† principali Biblo, Sidone e Tiro.</p>
        <p><strong>Ebrei:</strong> stabiliti nell'entroterra, nell'area che sarebbe poi divenuta la Terra d'Israele.</p>
        <p style="margin-top:14px;color:var(--muted)">Questa pagina integra contenuti storici con una sezione video e un pannello amministrazione discreto.</p>
      </article>
      <figure class="panel home-figure" aria-label="Cartina di Canaan">
        <img src="canaan-map.jpg" alt="Cartina storica della regione di Canaan" />
      </figure>
    </div>
  </main>

  <!-- VIDEO SECTION -->
  <section id="videoSection" class="section hidden" aria-label="Sezione video">
    <div class="video-container">
      <div class="video-toolbar panel" role="toolbar">
        <button id="openUpload" class="btn" aria-controls="uploadModal" aria-expanded="false">‚¨ÜÔ∏è Carica</button>
        <input id="searchVideos" class="input" placeholder="Cerca video per titolo o URL" />
        <button id="backHome" class="btn">üè† Home</button>
      </div>
      <div id="videoContainer" class="cards" aria-live="polite" aria-busy="false"></div>
    </div>
  </section>

  <!-- ADMIN SECTION (hidden until unlocked) -->
  <section id="adminSection" class="section hidden" aria-label="Admin">
    <div class="admin-section">
      <div class="admin-panel">
        <h2>üîß Pannello amministrazione</h2>
        <p style="color:var(--muted)">Modifica titoli, resetta views, elimina, pubblica/nascondi. Le azioni sono persistenzi locali.</p>
        <table class="admin-grid" id="adminGrid">
          <thead><tr><th>Anteprima</th><th>Titolo</th><th>Views</th><th>Stato</th><th>Azioni</th></tr></thead>
          <tbody id="adminBody"></tbody>
        </table>
        <div style="margin-top:12px;">
          <button id="adminToVideo" class="btn">üé¨ Vai ai video</button>
          <button id="adminToHome" class="btn">üè† Torna alla home</button>
        </div>
      </div>
    </div>
  </section>

  <!-- UPLOAD MODAL -->
  <div id="uploadModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-panel" role="document">
      <h3 id="uploadTitle">Upload Video</h3>
      <div style="margin-top:8px">
        <label for="videoFile">File</label><br>
        <input id="videoFile" type="file" accept="video/*" />
      </div>
      <div style="margin-top:8px">
        <label for="videoTitle">Titolo</label><br>
        <input id="videoTitle" class="input" />
      </div>
      <div class="modal-actions">
        <button id="uploadBtn" class="btn">Carica</button>
        <button id="closeUpload" class="btn">Chiudi</button>
      </div>
      <div id="uploadStatus" class="status-line" aria-live="polite"></div>
    </div>
  </div>

  <!-- discreet admin anchor bottom-left -->
  <div class="admin-anchor" aria-hidden="false">
    <button id="adminAnchorBtn" class="admin-btn" title="Admin">‚óè</button>
    <div id="adminInputWrap" class="admin-input-wrap" aria-hidden="true">
      <input id="adminInput" class="admin-input" type="text" autocomplete="off" spellcheck="false" aria-label="Passphrase admin" />
      <button id="adminSubmit" class="btn">Apri</button>
    </div>
  </div>

  <script>
    /* ---------------------------
       Storage helpers & constants
       --------------------------- */
    const STORAGE_KEY = 'jiorroVideos_v3'; // bumped version for this extended file
    const ADMIN_PASS = 'JIORR0CON$=LE';   // exact passphrase required

    function getSaved() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (err) {
        console.error('getSaved parse error', err);
        return [];
      }
    }
    function setSaved(arr) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || []));
      } catch (err) {
        console.error('setSaved error', err);
      }
    }

    // Small action history (in-memory) for undo support
    const actionHistory = [];

    /* ---------------------------
       Basic navigation & helpers
       --------------------------- */
    const lensBtn = document.getElementById('lensBtn');
    const statusEl = document.getElementById('statusEl');
    const homeSection = document.getElementById('homeSection');
    const videoSection = document.getElementById('videoSection');
    const adminSection = document.getElementById('adminSection');
    const backHome = document.getElementById('backHome');

    function showStatus(msg, type) {
      statusEl.textContent = msg || '';
      statusEl.className = 'status' + (type ? ' ' + type : '');
    }
    function showHome() {
      homeSection.classList.remove('hidden');
      videoSection.classList.add('hidden');
      adminSection.classList.add('hidden');
      showStatus('');
    }
    function showVideo() {
      homeSection.classList.add('hidden');
      adminSection.classList.add('hidden');
      videoSection.classList.remove('hidden');
      showStatus('‚úÖ Sezione video aperta', 'success');
      setTimeout(() => showStatus(''), 900);
    }
    function showAdmin() {
      homeSection.classList.add('hidden');
      videoSection.classList.add('hidden');
      adminSection.classList.remove('hidden');
      showStatus('üîß Admin sbloccato', 'success');
      setTimeout(() => showStatus(''), 900);
    }

    lensBtn.addEventListener('click', showVideo);
    backHome && backHome.addEventListener('click', showHome);

    /* ---------------------------
       Video module (render, upload, search, views)
       --------------------------- */
    (function VideoModule() {
      const openUploadBtn = document.getElementById('openUpload');
      const uploadModal = document.getElementById('uploadModal');
      const closeUploadBtn = document.getElementById('closeUpload');
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('videoFile');
      const titleInput = document.getElementById('videoTitle');
      const uploadStatus = document.getElementById('uploadStatus');
      const videoContainer = document.getElementById('videoContainer');
      const searchVideos = document.getElementById('searchVideos');

      // Defensive DOM checks
      function safe(elId) {
        const el = document.getElementById(elId);
        if (!el) console.warn('Missing element:', elId);
        return el;
      }

      function openModal() {
        if (!uploadModal) return;
        uploadModal.classList.add('show');
        openUploadBtn && openUploadBtn.setAttribute('aria-expanded', 'true');
      }
      function closeModal() {
        if (!uploadModal) return;
        uploadModal.classList.remove('show');
        openUploadBtn && openUploadBtn.setAttribute('aria-expanded', 'false');
        uploadStatus.textContent = '';
        fileInput.value = '';
        titleInput.value = '';
      }

      // Create a single video card element with protections and view counting
      function createCard(item) {
        const card = document.createElement('div');
        card.className = 'card video-card';
        card.dataset.url = item.url || '';

        const videoEl = document.createElement('video');
        videoEl.src = item.url || '';
        videoEl.controls = true;
        videoEl.preload = 'metadata';
        videoEl.setAttribute('controlsList', 'nodownload');
        videoEl.addEventListener('contextmenu', e => e.preventDefault());

        const titleEl = document.createElement('div');
        titleEl.className = 'title video-title';
        titleEl.textContent = item.title || 'Video senza titolo';

        const viewsEl = document.createElement('div');
        viewsEl.className = 'views video-views';
        viewsEl.textContent = `üëÅÔ∏è ${item.views || 0} views`;

        // Count views once per page load per element
        let counted = false;
        videoEl.addEventListener('play', () => {
          if (counted) return;
          counted = true;
          const saved = getSaved().map(s => {
            if (s.url === item.url) {
              s.views = (s.views || 0) + 1;
            }
            return s;
          });
          setSaved(saved);
          const updated = saved.find(s => s.url === item.url);
          viewsEl.textContent = `üëÅÔ∏è ${updated ? updated.views || 0 : 0} views`;
          // Update admin table if visible
          if (typeof window.renderAdminTable === 'function') window.renderAdminTable();
        });

        card.appendChild(videoEl);
        card.appendChild(titleEl);
        card.appendChild(viewsEl);
        return card;
      }

      // Render published videos; show friendly message if none
      function renderAll() {
        if (!videoContainer) return;
        videoContainer.setAttribute('aria-busy', 'true');
        videoContainer.innerHTML = '';
        const saved = getSaved().filter(v => v.published !== false).sort((a, b) => (b.views || 0) - (a.views || 0));
        if (!saved.length) {
          const info = document.createElement('div');
          info.style.color = 'var(--muted)';
          info.textContent = 'Nessun video pubblicato. Carica un video per iniziare.';
          videoContainer.appendChild(info);
        } else {
          saved.forEach(item => videoContainer.appendChild(createCard(item)));
        }
        videoContainer.setAttribute('aria-busy', 'false');
      }

      // Wire events
      window.addEventListener('DOMContentLoaded', renderAll);
      openUploadBtn && openUploadBtn.addEventListener('click', openModal);
      closeUploadBtn && closeUploadBtn.addEventListener('click', closeModal);

      // Upload with Cloudinary; adjust preset if needed
      uploadBtn && uploadBtn.addEventListener('click', async () => {
        const file = fileInput.files && fileInput.files[0];
        const title = (titleInput.value || '').trim();

        if (!file) {
          uploadStatus.textContent = '‚ùå Seleziona un file video.';
          uploadStatus.className = 'status-line error';
          return;
        }
        if (!file.type || !file.type.startsWith('video/')) {
          uploadStatus.textContent = '‚ùå Il file non √® un video valido.';
          uploadStatus.className = 'status-line error';
          return;
        }

        uploadStatus.textContent = '‚è≥ Caricamento in corso...';
        uploadStatus.className = 'status-line';

        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', 'jiorro_upload'); // change if needed

        try {
          const res = await fetch('https://api.cloudinary.com/v1_1/dng8rjd6u/auto/upload', { method: 'POST', body: form });
          const data = await res.json();
          if (!res.ok || data.error) {
            uploadStatus.textContent = '‚ùå ' + (data?.error?.message || 'Errore Cloudinary');
            uploadStatus.className = 'status-line error';
            return;
          }
          const url = data.secure_url;
          if (!url) {
            uploadStatus.textContent = '‚ùå URL non ricevuto.';
            uploadStatus.className = 'status-line error';
            return;
          }

          // Persist new video (published by default)
          const saved = getSaved();
          saved.unshift({ url, title, views: 0, published: true });
          setSaved(saved);
          renderAll();
          if (typeof window.renderAdminTable === 'function') window.renderAdminTable();

          uploadStatus.textContent = '‚úÖ Video caricato!';
          uploadStatus.className = 'status-line success';
          fileInput.value = '';
          titleInput.value = '';
        } catch (err) {
          console.error('Upload error', err);
          uploadStatus.textContent = "‚ùå Errore durante l'upload.";
          uploadStatus.className = 'status-line error';
        }
      });

      // Internal search in the displayed grid
      searchVideos && searchVideos.addEventListener('input', () => {
        const term = (searchVideos.value || '').toLowerCase();
        document.querySelectorAll('.video-card').forEach(card => {
          const src = (card.querySelector('video')?.src || '').toLowerCase();
          const title = (card.querySelector('.video-title')?.textContent || '').toLowerCase();
          const match = !term || src.includes(term) || title.includes(term);
          card.style.display = match ? 'flex' : 'none';
        });
      });

      // Expose public render for admin sync
      window.renderAllVideosPublic = renderAll;
    })();

    /* ---------------------------
       Discreet admin anchor: bottom-left small button + input
       - toggles minimal input with no placeholder/hint
       - exact passphrase unlocks admin
       --------------------------- */
    (function AdminAnchor() {
      const ANCHOR_BTN = document.getElementById('adminAnchorBtn');
      const INPUT_WRAP = document.getElementById('adminInputWrap');
      const ADMIN_INPUT = document.getElementById('adminInput');
      const ADMIN_SUBMIT = document.getElementById('adminSubmit');

      function openTinyInput() {
        INPUT_WRAP.style.display = 'flex';
        INPUT_WRAP.setAttribute('aria-hidden', 'false');
        ADMIN_INPUT.focus();
        ADMIN_INPUT.select();
      }
      function closeTinyInput() {
        INPUT_WRAP.style.display = 'none';
        INPUT_WRAP.setAttribute('aria-hidden', 'true');
        ADMIN_INPUT.value = '';
      }

      ANCHOR_BTN.addEventListener('click', () => {
        const isOpen = INPUT_WRAP.style.display === 'flex';
        if (isOpen) closeTinyInput(); else openTinyInput();
      });

      function tryUnlock() {
        const val = (ADMIN_INPUT.value || '').trim();
        if (val === ADMIN_PASS) {
          closeTinyInput();
          if (typeof window.renderAdminTable === 'function') window.renderAdminTable();
          showAdmin();
        } else {
          ADMIN_INPUT.style.transition = 'transform .12s';
          ADMIN_INPUT.style.transform = 'translateX(-6px)';
          setTimeout(() => ADMIN_INPUT.style.transform = 'translateX(6px)', 120);
          setTimeout(() => ADMIN_INPUT.style.transform = '', 240);
          ADMIN_INPUT.value = '';
          ADMIN_INPUT.focus();
        }
      }

      ADMIN_SUBMIT.addEventListener('click', tryUnlock);
      ADMIN_INPUT.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryUnlock(); });

      // ESC closes admin and tiny input
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeTinyInput();
          adminSection.classList.add('hidden');
          homeSection.classList.remove('hidden');
          videoSection.classList.add('hidden');
          showStatus('');
        }
      });
    })();

    /* ---------------------------
       Admin panel: render table + actions
       - edit title (save)
       - reset views (confirm)
       - toggle published
       - delete with undo
       --------------------------- */
    (function AdminPanel() {
      const adminBody = document.getElementById('adminBody');
      const adminToVideo = document.getElementById('adminToVideo');
      const adminToHome = document.getElementById('adminToHome');

      // helper: create element safely
      function el(tag, props = {}, children = []) {
        const e = document.createElement(tag);
        Object.assign(e, props);
        children.forEach(c => e.appendChild(c));
        return e;
      }

      // render the admin table based on storage
      function renderAdminTable() {
        const saved = getSaved();
        adminBody.innerHTML = ''; // clear existing rows

        // show message if empty
        if (!saved.length) {
          const tr = el('tr');
          const td = el('td', { colSpan: 5, textContent: 'Nessun video salvato.' });
          td.style.color = 'var(--muted)';
          tr.appendChild(td);
          adminBody.appendChild(tr);
          return;
        }

        // build rows
        saved.forEach((item, idx) => {
          const tr = el('tr');

          // preview cell
          const tdPrev = el('td');
          const preview = el('video', { src: item.url, preload: 'metadata', controls: true });
          preview.style.maxWidth = '160px';
          preview.setAttribute('controlsList', 'nodownload');
          preview.addEventListener('contextmenu', e => e.preventDefault());
          tdPrev.appendChild(preview);

          // title cell (editable)
          const tdTitle = el('td');
          const titleInput = el('input', { className: 'input', value: item.title || '' });
          tdTitle.appendChild(titleInput);

          // views cell
          const tdViews = el('td');
          const pillV = el('span', { className: 'pill', textContent: (item.views || 0) + ' views' });
          tdViews.appendChild(pillV);

          // status cell
          const tdStatus = el('td');
          const pillS = el('span', { className: 'pill ' + (item.published === false ? '' : 'pub'), textContent: item.published === false ? 'Non pubblicato' : 'Pubblicato' });
          tdStatus.appendChild(pillS);

          // actions cell
          const tdActions = el('td');
          const actions = el('div', { className: 'actions' });

          const btnSave = el('button', { className: 'btn', textContent: 'üíæ Salva' });
          const btnReset = el('button', { className: 'btn', textContent: 'üîÑ Reset' });
          const btnToggle = el('button', { className: 'btn', textContent: item.published === false ? 'üì¢ Pubblica' : 'üôà Nascondi' });
          const btnDel = el('button', { className: 'btn danger', textContent: 'üóëÔ∏è Elimina' });

          actions.appendChild(btnSave);
          actions.appendChild(btnReset);
          actions.appendChild(btnToggle);
          actions.appendChild(btnDel);
          tdActions.appendChild(actions);

          tr.appendChild(tdPrev);
          tr.appendChild(tdTitle);
          tr.appendChild(tdViews);
          tr.appendChild(tdStatus);
          tr.appendChild(tdActions);
          adminBody.appendChild(tr);

          // ---------------------
          // Handlers for actions
          // ---------------------
          btnSave.addEventListener('click', () => {
            const s = getSaved();
            s[idx].title = titleInput.value.trim();
            setSaved(s);
            renderAdminTable();
            if (typeof window.renderAllVideosPublic === 'function') window.renderAllVideosPublic();
            showStatus('Titolo aggiornato', 'success');
            setTimeout(() => showStatus(''), 900);
          });

          btnReset.addEventListener('click', () => {
            if (!confirm('Resetta le views a 0 per questo video?')) return;
            const s = getSaved();
            s[idx].views = 0;
            setSaved(s);
            renderAdminTable();
            if (typeof window.renderAllVideosPublic === 'function') window.renderAllVideosPublic();
            showStatus('Views resettate', 'success');
            setTimeout(() => showStatus(''), 900);
          });

          btnToggle.addEventListener('click', () => {
            const s = getSaved();
            s[idx].published = !(s[idx].published === false);
            setSaved(s);
            renderAdminTable();
            if (typeof window.renderAllVideosPublic === 'function') window.renderAllVideosPublic();
            showStatus(s[idx].published ? 'Video pubblicato' : 'Video nascosto', 'success');
            setTimeout(() => showStatus(''), 900);
          });

          btnDel.addEventListener('click', () => {
            // delete with undo: keep last action in memory for 6s
            if (!confirm('Sei sicuro di eliminare questo video dall\'indice locale?')) return;
            const s = getSaved();
            const removed = s.splice(idx, 1)[0];
            setSaved(s);
            renderAdminTable();
            if (typeof window.renderAllVideosPublic === 'function') window.renderAllVideosPublic();
            // push to action history for undo
            actionHistory.push({ type: 'delete', item: removed, index: idx, time: Date.now() });
            showStatus('Video eliminato. Annulla?', 'error');
            // small undo button via status click
            statusEl.addEventListener('click', function undoOnce() {
              const last = actionHistory.pop();
              if (last && last.type === 'delete') {
                const cur = getSaved();
                cur.splice(last.index, 0, last.item);
                setSaved(cur);
                renderAdminTable();
                if (typeof window.renderAllVideosPublic === 'function') window.renderAllVideosPublic();
                showStatus('Eliminazione annullata', 'success');
                setTimeout(() => showStatus(''), 900);
              }
              statusEl.removeEventListener('click', undoOnce);
            });
            // auto-clear history after 6 seconds (prevent stacking)
            setTimeout(() => {
              const head = actionHistory[actionHistory.length - 1];
              if (head && head.type === 'delete' && Date.now() - head.time > 6000) actionHistory.pop();
            }, 6100);
          });
        });
      }

      // expose
      window.renderAdminTable = renderAdminTable;

      // nav shortcuts
      adminToVideo && adminToVideo.addEventListener('click', () => {
        document.getElementById('videoSection').classList.remove('hidden');
        document.getElementById('adminSection').classList.add('hidden');
        renderAllVideosPublic && renderAllVideosPublic();
      });
      adminToHome && adminToHome.addEventListener('click', () => {
        document.getElementById('homeSection').classList.remove('hidden');
        document.getElementById('adminSection').classList.add('hidden');
      });
    })();

    /* ---------------------------
       End of script
       --------------------------- */
    // quick debug: log existing saved videos on load
    window.addEventListener('load', () => {
      try { console.info('Jiorro saved videos:', JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')); }
      catch (e) { console.warn('Unable to parse saved videos', e); }
    });
  </script>
</body>
</html>
