
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Canaan & Jiorro Video ‚Äî Overlay Fullscreen J</title>
  <title>Jiorro Video ‚Äî robust upload & admin</title>
  <style>
    /* -------------------------
       Theme e layout principali
       ------------------------- */
    :root{
      --bg:#0f0f10; --panel:#18181b; --border:#2a2a31; --text:#fff;
      --muted:#b7b7c3; --accent:#6ff66f; --brand:#66aaff; --danger:#ff6666;
      --shadow:rgba(0,0,0,0.35);
      --max-upload-mb:200; /* indicativo, il limite reale dipende da Cloudinary */
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    *{box-sizing:border-box}
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:flex-end;padding:0 18px;background:linear-gradient(to bottom, rgba(24,24,27,0.95), rgba(24,24,27,0.7));border-bottom:1px solid var(--border);z-index:1000;backdrop-filter:blur(6px)}
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:flex-end;padding:0 18px;background:linear-gradient(to bottom, rgba(24,24,27,0.95), rgba(24,24,27,0.7));border-bottom:1px solid var(--border);z-index:1000}
    .lens-btn{width:44px;height:44px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:20px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .status{position:fixed;top:70px;right:20px;font-size:13px;color:var(--muted);z-index:950;text-align:right}
    .status.success{color:var(--accent)} .status.error{color:var(--danger)}
    .section{padding-top:96px;min-height:100vh}
    .hidden{display:none}
    .home-container{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;padding:28px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 14px 36px var(--shadow)}
    .home-figure img{max-width:100%;border-radius:10px;border:1px solid var(--border)}
    .video-container{padding:28px;display:grid;gap:16px}
    .video-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px;border-radius:12px}
    .btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-2px)}
    .input{background:var(--panel);border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text)}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:12px;box-shadow:0 10px 30px var(--shadow);display:flex;flex-direction:column;gap:8px}
    .card video{width:100%;border-radius:8px;background:black}
    /* admin anchor */
    /* modal upload */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    .modal.show{display:flex}
    .modal-panel{width:92%;max-width:680px;background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:12px;box-shadow:0 14px 44px var(--shadow)}
    .progress{height:8px;border-radius:999px;background:#111;margin-top:8px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .2s}
    .status-line{margin-top:8px;color:var(--muted);min-height:18px}
    .status-line.success{color:var(--accent)} .status-line.error{color:var(--danger)}
    /* admin anchor bottom-left */
    .admin-anchor{position:fixed;left:12px;bottom:12px;z-index:1300;display:flex;flex-direction:column;align-items:flex-start;gap:8px}
    .admin-btn{width:44px;height:44px;border-radius:999px;background:var(--panel);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;color:var(--text);font-size:18px;cursor:pointer}
    .admin-input-wrap{display:none;gap:8px;align-items:center}
    .admin-input{width:220px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none;caret-color:var(--text)}
    .admin-input{width:220px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none;caret-color:var(--text);autocomplete:off}
    table.admin-grid{width:100%;border-collapse:collapse;margin-top:12px}
    table.admin-grid th, table.admin-grid td{padding:10px;border-top:1px solid var(--border);vertical-align:middle}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202025;color:var(--muted);border:1px solid var(--border);font-size:13px}
    .pill.pub{background:#103016;color:var(--accent);border-color:#244b2f}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    /* overlay styles */
    .overlay-fullscreen {
      position:fixed; inset:0; z-index:20000; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.95);
    }
    .overlay-fullscreen video {
      width:100%; height:100%; object-fit:contain; background:black;
    }
    /* overlay fullscreen J */
    .overlay-fullscreen{position:fixed;inset:0;z-index:20000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.98)}
    .overlay-fullscreen video{width:100%;height:100%;object-fit:contain;background:black}
    @media(max-width:980px){.home-container{grid-template-columns:1fr}.admin-input{width:150px}}
  </style>
</head>
@@ -70,7 +79,7 @@ <h1>La regione di Canaan</h1>
    <div class="video-container">
      <div class="video-toolbar panel" role="toolbar">
        <button id="openUpload" class="btn" aria-controls="uploadModal" aria-expanded="false">‚¨ÜÔ∏è Carica</button>
        <input id="searchVideos" class="input" aria-label="Cerca video" />
        <input id="searchVideos" class="input" placeholder="Cerca video per titolo o URL" />
        <button id="backHome" class="btn">üè† Home</button>
      </div>
      <div id="videoContainer" class="cards" aria-live="polite" aria-busy="false"></div>
@@ -80,7 +89,7 @@ <h1>La regione di Canaan</h1>
  <section id="adminSection" class="section hidden" aria-label="Admin">
    <div class="panel">
      <h2>üîß Pannello amministrazione</h2>
      <p style="color:var(--muted)">Modifica titoli, resetta views, elimina o cambia stato pubblicazione. Dati persistono solo su questo browser.</p>
      <p style="color:var(--muted)">Modifica titoli, resetta views, elimina, pubblica/nascondi. Persistenza locale (localStorage) e upload su Cloudinary.</p>
      <table class="admin-grid" id="adminGrid">
        <thead><tr><th>Anteprima</th><th>Titolo</th><th>Views</th><th>Stato</th><th>Azioni</th></tr></thead>
        <tbody id="adminBody"></tbody>
@@ -89,13 +98,30 @@ <h2>üîß Pannello amministrazione</h2>
    </div>
  </section>

  <div id="uploadModal" class="hidden" role="dialog" aria-modal="true">
    <div style="max-width:560px;margin:40px auto;padding:18px;border-radius:12px;background:var(--panel);border:1px solid var(--border)">
      <h3>Upload Video</h3>
      <div style="margin-top:8px"><label for="videoFile">File</label><br><input id="videoFile" type="file" accept="video/*" /></div>
      <div style="margin-top:8px"><label for="videoTitle">Titolo</label><br><input id="videoTitle" class="input" /></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button id="uploadBtn" class="btn">Carica</button><button id="closeUpload" class="btn">Chiudi</button></div>
      <div id="uploadStatus" style="margin-top:10px;color:var(--muted)"></div>
  <!-- upload modal -->
  <div id="uploadModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-panel" role="document">
      <h3 id="uploadTitle">Upload Video</h3>
      <div style="margin-top:8px">
        <label for="videoFile">File</label><br>
        <input id="videoFile" type="file" accept="video/*" />
      </div>
      <div style="margin-top:8px">
        <label for="videoTitle">Titolo</label><br>
        <input id="videoTitle" class="input" placeholder="Titolo (opzionale)" />
      </div>
      <div style="margin-top:8px">
        <label for="overlaySrc">Overlay source (opzionale)</label><br>
        <input id="overlaySrc" class="input" placeholder="URL usato dal toggle J (data-overlay-src)" />
      </div>
      <div class="progress" aria-hidden="true"><i id="uploadProgress"></i></div>
      <div class="modal-actions" style="margin-top:10px">
        <button id="uploadBtn" class="btn">Carica</button>
        <button id="closeUpload" class="btn">Chiudi</button>
      </div>
      <div id="uploadStatus" class="status-line" aria-live="polite"></div>
      <hr style="margin-top:12px;border-color:var(--border)">
      <div style="font-size:13px;color:var(--muted)">Note: il preset deve essere unsigned per gli upload diretti dal browser. Verifica cloud name e preset nelle impostazioni qui sotto.</div>
    </div>
  </div>

@@ -110,22 +136,27 @@ <h3>Upload Video</h3>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      /* STORAGE & ADMIN PASS */
      const STORAGE_KEY = 'jiorroVideos_v3';
      const ADMIN_PASS = 'JIORR0CON$=LE'; // unchanged

      /* FALLBACK OVERLAY URL: cambia con la sorgente che vuoi usare */
      const FALLBACK_OVERLAY_URL = 'https://res.cloudinary.com/demo/video/upload/sample.mp4';
      /* ============= CONFIG (modifica qui se necessario) ============= */
      const STORAGE_KEY = 'jiorroVideos_secure_v1';
      const ADMIN_PASS = 'JIORR0CON$=LE'; // esatto, case-sensitive
      const CLOUDINARY_CLOUD = 'dng8rjd6u'; // Sostituisci con il tuo cloud name se diverso
      const UPLOAD_PRESET = 'jiorro_upload'; // Deve essere un preset unsigned per upload client-side
      const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;
      const MAX_FILE_MB = 800; // fallback: Cloudinary pu√≤ supportare grandi file ma il piano pu√≤ limitare
      const UPLOAD_TIMEOUT_MS = 3 * 60 * 1000; // 3 minuti di timeout (configurabile)

      /* Basic helpers */
      /* ============= helper storage & ui ============= */
      function getSaved(){
        try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
        catch(e){ console.error('getSaved parse error', e); return []; }
        try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch (e) { console.error('getSaved parse error', e); return []; }
      }
      function setSaved(arr){
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || [])); } catch (e) { console.error('setSaved error', e); }
      }
      function showStatus(msg, type){
        const s = document.getElementById('statusEl'); s.textContent = msg || ''; s.className = 'status' + (type ? ' ' + type : '');
      }
      function setSaved(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || [])); } catch(e){ console.error('setSaved', e); } }
      function showStatus(msg, type){ const s = document.getElementById('statusEl'); s.textContent = msg || ''; s.className = 'status' + (type ? ' ' + type : ''); }

      /* UI refs */
      /* ============= refs ============= */
      const lensBtn = document.getElementById('lensBtn');
      const homeSection = document.getElementById('homeSection');
      const videoSection = document.getElementById('videoSection');
@@ -140,7 +171,9 @@ <h3>Upload Video</h3>
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('videoFile');
      const titleInput = document.getElementById('videoTitle');
      const overlaySrcInput = document.getElementById('overlaySrc');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadProgress = document.getElementById('uploadProgress');

      const adminAnchorBtn = document.getElementById('adminAnchorBtn');
      const adminInputWrap = document.getElementById('adminInputWrap');
@@ -150,241 +183,347 @@ <h3>Upload Video</h3>
      const adminToVideo = document.getElementById('adminToVideo');
      const adminToHome = document.getElementById('adminToHome');

      /* NAV helpers */
      /* ============= NAV helpers ============= */
      function showHome(){ homeSection.classList.remove('hidden'); videoSection.classList.add('hidden'); adminSection.classList.add('hidden'); showStatus(''); }
      function showVideo(){ homeSection.classList.add('hidden'); adminSection.classList.add('hidden'); videoSection.classList.remove('hidden'); showStatus('‚úÖ Sezione video aperta','success'); setTimeout(()=>showStatus(''),900); }
      function showAdmin(){ homeSection.classList.add('hidden'); videoSection.classList.add('hidden'); adminSection.classList.remove('hidden'); showStatus('üîß Admin sbloccato','success'); setTimeout(()=>showStatus(''),900); }

      lensBtn.addEventListener('click', showVideo);
      backHome && backHome.addEventListener('click', showHome);

      /* PUBLIC VIDEO RENDER */
      /* ============= RENDER PUBLIC VIDEOS ============= */
      function createCard(item){
        const card = document.createElement('div'); card.className = 'card video-card';
        const v = document.createElement('video'); v.src = item.url; v.controls = true; v.preload='metadata'; v.setAttribute('controlsList','nodownload'); v.addEventListener('contextmenu', e=>e.preventDefault());
        // attach optional overlay source per card
        const v = document.createElement('video');
        v.src = item.url;
        v.controls = true;
        v.preload = 'metadata';
        v.setAttribute('controlsList','nodownload');
        v.addEventListener('contextmenu', e => e.preventDefault());
        if (item.overlaySrc) v.dataset.overlaySrc = item.overlaySrc;
        const t = document.createElement('div'); t.className='title'; t.textContent = item.title || 'Video senza titolo';
        const vw = document.createElement('div'); vw.className='views'; vw.textContent = 'üëÅÔ∏è ' + (item.views||0) + ' views';
        const vw = document.createElement('div'); vw.className='views'; vw.textContent = 'üëÅÔ∏è ' + (item.views || 0) + ' views';
        let counted = false;
        v.addEventListener('play', () => {
          if (counted) return; counted = true;
          const saved = getSaved().map(s => { if (s.url === item.url) s.views = (s.views||0)+1; return s; });
          const saved = getSaved().map(s => { if (s.url === item.url) s.views = (s.views || 0) + 1; return s; });
          setSaved(saved);
          const updated = saved.find(s=>s.url===item.url);
          const updated = saved.find(s => s.url === item.url);
          vw.textContent = 'üëÅÔ∏è ' + ((updated && updated.views) || 0) + ' views';
          if (typeof window.renderAdminTable === 'function') window.renderAdminTable();
        });
        card.appendChild(v); card.appendChild(t); card.appendChild(vw);
        return card;
      }

      function renderAll(){
        if(!videoContainer) return;
        videoContainer.innerHTML = '';
        const saved = getSaved().filter(v => v.published !== false).sort((a,b)=> (b.views||0)-(a.views||0));
        if(!saved.length){ const info = document.createElement('div'); info.style.color='var(--muted)'; info.textContent='Nessun video pubblicato. Carica un video per iniziare.'; videoContainer.appendChild(info); }
        else saved.forEach(i => videoContainer.appendChild(createCard(i)));
        const saved = getSaved().filter(v => v.published !== false).sort((a,b) => (b.views || 0) - (a.views || 0));
        if (!saved.length){
          const info = document.createElement('div'); info.style.color = 'var(--muted)'; info.textContent = 'Nessun video pubblicato. Carica un video per iniziare.'; videoContainer.appendChild(info);
        } else {
          saved.forEach(i => videoContainer.appendChild(createCard(i)));
        }
      }
      window.renderAllVideosPublic = renderAll;

      /* UPLOAD (kept minimal) */
      function openUpload(){ uploadModal.classList.remove('hidden'); }
      function closeUpload(){ uploadModal.classList.add('hidden'); uploadStatus.textContent=''; fileInput.value=''; titleInput.value=''; }
      /* ============= UPLOAD: robust implementation ============= */
      function openUpload(){ uploadModal.classList.add('show'); openUploadBtn && openUploadBtn.setAttribute('aria-expanded','true'); }
      function closeUpload(){ uploadModal.classList.remove('show'); openUploadBtn && openUploadBtn.setAttribute('aria-expanded','false'); uploadStatus.textContent=''; uploadProgress.style.width='0%'; fileInput.value=''; titleInput.value=''; overlaySrcInput.value=''; }

      openUploadBtn && openUploadBtn.addEventListener('click', openUpload);
      closeUploadBtn && closeUploadBtn.addEventListener('click', closeUpload);
      if(uploadBtn){
        uploadBtn.addEventListener('click', async () => {
          const file = fileInput.files && fileInput.files[0];
          const title = (titleInput.value||'').trim();
          if(!file){ uploadStatus.textContent='‚ùå Seleziona un file video.'; return; }
          if(!file.type || !file.type.startsWith('video/')){ uploadStatus.textContent='‚ùå Il file non √® un video valido.'; return; }
          uploadStatus.textContent='‚è≥ Caricamento in corso...';
          const form = new FormData(); form.append('file', file); form.append('upload_preset', 'jiorro_upload');
          try {
            const res = await fetch('https://api.cloudinary.com/v1_1/dng8rjd6u/auto/upload', { method:'POST', body: form });
            const data = await res.json();
            if(!res.ok || data.error){ uploadStatus.textContent='‚ùå ' + (data?.error?.message || 'Errore Cloudinary'); return; }
            const url = data.secure_url;
            if(!url){ uploadStatus.textContent='‚ùå URL non ricevuto.'; return; }
            const saved = getSaved(); saved.unshift({ url, title, views:0, published:true }); setSaved(saved);
            renderAll(); if(typeof window.renderAdminTable==='function') window.renderAdminTable();
            uploadStatus.textContent='‚úÖ Video caricato!'; fileInput.value=''; titleInput.value=''; setTimeout(closeUpload,700);
          } catch(e){ console.error('upload', e); uploadStatus.textContent="‚ùå Errore durante l'upload."; }

      function humanFileSize(bytes){
        const thresh = 1024;
        if(Math.abs(bytes) < thresh) return bytes + ' B';
        const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
        let u = -1;
        do { bytes /= thresh; ++u; } while(Math.abs(bytes) >= thresh && u < units.length - 1);
        return bytes.toFixed(1) + ' ' + units[u];
      }

      async function uploadToCloudinary(file, title, overlaySrc, onProgress){
        // Validations
        if(!file) throw new Error('no-file');
        const sizeMb = file.size / (1024*1024);
        if(sizeMb > MAX_FILE_MB) throw new Error('file-too-large');
        // Build form
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', UPLOAD_PRESET);
        // optional metadata
        form.append('context', `caption=${title || ''}`);
        // Start fetch with progress using XMLHttpRequest for progress events
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', CLOUDINARY_URL);
          xhr.timeout = UPLOAD_TIMEOUT_MS;
          xhr.onload = function(){
            if(xhr.status >= 200 && xhr.status < 300){
              try { const data = JSON.parse(xhr.responseText); if (data && data.secure_url) resolve(data); else reject(new Error('no-url')); }
              catch(e){ reject(e); }
            } else {
              try { const err = JSON.parse(xhr.responseText); reject(new Error(err?.error?.message || 'upload-failed')); } catch(e){ reject(new Error('upload-failed')); }
            }
          };
          xhr.onerror = function(){ reject(new Error('network-error')); };
          xhr.ontimeout = function(){ reject(new Error('timeout')); };
          xhr.upload.onprogress = function(ev){
            if(ev.lengthComputable && typeof onProgress === 'function'){
              const pct = Math.round((ev.loaded / ev.total) * 100);
              onProgress(pct, ev.loaded, ev.total);
            }
          };
          xhr.send(form);
        });
      }

      /* ADMIN anchor & unlock (unchanged discrete behavior) */
      async function handleUpload(){
        uploadStatus.textContent = '';
        const file = fileInput.files && fileInput.files[0];
        const title = (titleInput.value || '').trim();
        const overlaySrc = (overlaySrcInput.value || '').trim() || null;

        if(!file){ uploadStatus.textContent = '‚ùå Seleziona un file video.'; return; }
        if(!file.type || !file.type.startsWith('video/')){ uploadStatus.textContent = '‚ùå Il file selezionato non √® un video.'; return; }

        const sizeMb = (file.size / (1024*1024)).toFixed(1);
        if(sizeMb > MAX_FILE_MB){ uploadStatus.textContent = `‚ùå File troppo grande: ${sizeMb} MB (limite locale ${MAX_FILE_MB} MB).`; return; }

        uploadStatus.textContent = `‚è≥ Caricamento ${sizeMb} MB...`;
        uploadProgress.style.width = '0%'; uploadProgress.parentElement.setAttribute('aria-hidden','false');

        try {
          const res = await uploadToCloudinary(file, title, overlaySrc, (pct) => {
            uploadProgress.style.width = pct + '%';
            uploadStatus.textContent = `‚è≥ Caricamento ${pct}%`;
          });
          // res contiene info Cloudinary; usa secure_url
          const url = res.secure_url;
          if(!url) throw new Error('no-url-returned');

          // salva in localStorage
          const saved = getSaved();
          saved.unshift({ url, title, overlaySrc, views: 0, published:true, uploadedAt: Date.now(), cloudResponse: { public_id: res.public_id } });
          setSaved(saved);

          renderAll();
          if(typeof window.renderAdminTable === 'function') window.renderAdminTable();

          uploadStatus.textContent = '‚úÖ Caricamento completato';
          uploadProgress.style.width = '100%';
          setTimeout(() => { closeUpload(); showStatus('Video caricato e pubblicato', 'success'); setTimeout(()=>showStatus(''), 900); }, 700);
        } catch (err) {
          console.error('upload failed:', err);
          const msg = (err && err.message) ? err.message : String(err);
          uploadStatus.textContent = `‚ùå Upload fallito: ${msg}`;
          showStatus('Upload fallito: controlla console e impostazioni Cloudinary', 'error');
        }
      }

      if(uploadBtn) uploadBtn.addEventListener('click', handleUpload);

      /* ============= ADMIN anchor & unlock (discreto) ============= */
      adminAnchorBtn.addEventListener('click', () => {
        const open = adminInputWrap.style.display === 'flex';
        if(open){ adminInputWrap.style.display='none'; adminInputWrap.setAttribute('aria-hidden','true'); adminInput.value=''; }
        else { adminInputWrap.style.display='flex'; adminInputWrap.setAttribute('aria-hidden','false'); adminInput.focus(); adminInput.select(); }
        if(open){ adminInputWrap.style.display = 'none'; adminInputWrap.setAttribute('aria-hidden','true'); adminInput.value = ''; }
        else { adminInputWrap.style.display = 'flex'; adminInputWrap.setAttribute('aria-hidden','false'); adminInput.focus(); adminInput.select(); }
      });

      function tryUnlockAdmin(){
        const v = (adminInput.value||'').trim();
        const v = (adminInput.value || '').trim();
        if(v === ADMIN_PASS){
          adminInputWrap.style.display='none'; adminInput.value='';
          if(typeof window.renderAdminTable==='function') window.renderAdminTable(); else setTimeout(()=>{ if(typeof window.renderAdminTable==='function') window.renderAdminTable(); },100);
          adminInputWrap.style.display = 'none';
          adminInput.value = '';
          // guaranteed render call with small retry
          if(typeof window.renderAdminTable === 'function') window.renderAdminTable();
          else setTimeout(()=>{ if(typeof window.renderAdminTable === 'function') window.renderAdminTable(); }, 100);
          showAdmin();
        } else {
          adminInput.style.transform='translateX(-6px)'; setTimeout(()=>adminInput.style.transform='translateX(6px)',120); setTimeout(()=>adminInput.style.transform='',240); adminInput.value=''; adminInput.focus();
          // subtle shake and reset
          adminInput.style.transition = 'transform .12s';
          adminInput.style.transform = 'translateX(-6px)';
          setTimeout(()=>adminInput.style.transform = 'translateX(6px)', 120);
          setTimeout(()=>adminInput.style.transform = '', 240);
          adminInput.value = ''; adminInput.focus();
        }
      }
      adminSubmit.addEventListener('click', tryUnlockAdmin);
      adminInput.addEventListener('keydown', (e) => { if(e.key==='Enter') tryUnlockAdmin(); });
      adminInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryUnlockAdmin(); });

      /* ADMIN panel rendering + actions */
      /* ============= ADMIN panel render & actions ============= */
      function renderAdminTable(){
        adminBody.innerHTML = '';
        const saved = getSaved();
        if(!saved.length){
          const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=5; td.textContent='Nessun video salvato.'; td.style.color='var(--muted)'; tr.appendChild(td); adminBody.appendChild(tr); return;
          const tr = document.createElement('tr');
          const td = document.createElement('td'); td.colSpan = 5; td.textContent = 'Nessun video salvato.'; td.style.color = 'var(--muted)';
          tr.appendChild(td); adminBody.appendChild(tr); return;
        }
        saved.forEach((item, idx) => {
          const tr = document.createElement('tr');
          const tdPrev = document.createElement('td');
          const p = document.createElement('video'); p.src=item.url; p.preload='metadata'; p.controls=true; p.style.maxWidth='160px'; p.setAttribute('controlsList','nodownload'); p.addEventListener('contextmenu', e=>e.preventDefault()); if(item.overlaySrc) p.dataset.overlaySrc=item.overlaySrc;
          tdPrev.appendChild(p);
          const tdTitle = document.createElement('td'); const titleInput = document.createElement('input'); titleInput.className='input'; titleInput.value=item.title||''; tdTitle.appendChild(titleInput);
          const tdViews = document.createElement('td'); const pillV = document.createElement('span'); pillV.className='pill'; pillV.textContent=(item.views||0)+' views'; tdViews.appendChild(pillV);
          const tdStatus = document.createElement('td'); const pillS = document.createElement('span'); pillS.className='pill '+(item.published===false?'':'pub'); pillS.textContent = item.published===false ? 'Non pubblicato' : 'Pubblicato'; tdStatus.appendChild(pillS);
          const tdActions = document.createElement('td'); const actions = document.createElement('div'); actions.className='actions';
          const btnSave=document.createElement('button');btnSave.className='btn';btnSave.textContent='üíæ Salva';
          const btnReset=document.createElement('button');btnReset.className='btn';btnReset.textContent='üîÑ Reset';
          const btnToggle=document.createElement('button');btnToggle.className='btn';btnToggle.textContent=item.published===false?'üì¢ Pubblica':'üôà Nascondi';
          const btnDel=document.createElement('button');btnDel.className='btn danger';btnDel.textContent='üóëÔ∏è Elimina';
          actions.append(btnSave,btnReset,btnToggle,btnDel); tdActions.appendChild(actions);
          tr.append(tdPrev,tdTitle,tdViews,tdStatus,tdActions); adminBody.appendChild(tr);

          btnSave.addEventListener('click', () => { const s=getSaved(); s[idx].title=titleInput.value.trim(); setSaved(s); renderAdminTable(); renderAll(); showStatus('Titolo aggiornato','success'); setTimeout(()=>showStatus(''),900); });
          btnReset.addEventListener('click', () => { if(!confirm('Resetta le views a 0 per questo video?')) return; const s=getSaved(); s[idx].views=0; setSaved(s); renderAdminTable(); renderAll(); showStatus('Views resettate','success'); setTimeout(()=>showStatus(''),900); });
          btnToggle.addEventListener('click', () => { const s=getSaved(); s[idx].published=!(s[idx].published===false); setSaved(s); renderAdminTable(); renderAll(); showStatus(s[idx].published ? 'Video pubblicato':'Video nascosto','success'); setTimeout(()=>showStatus(''),900); });
          btnDel.addEventListener('click', () => { if(!confirm("Sei sicuro di eliminare questo video dall'indice locale?")) return; const s=getSaved(); s.splice(idx,1); setSaved(s); renderAdminTable(); renderAll(); showStatus('Video eliminato','error'); setTimeout(()=>showStatus(''),1200); });
          const prevV = document.createElement('video'); prevV.src = item.url; prevV.preload = 'metadata'; prevV.controls = true; prevV.style.maxWidth = '160px'; prevV.setAttribute('controlsList','nodownload'); prevV.addEventListener('contextmenu', e => e.preventDefault());
          if(item.overlaySrc) prevV.dataset.overlaySrc = item.overlaySrc;
          tdPrev.appendChild(prevV);

          const tdTitle = document.createElement('td');
          const titleInput = document.createElement('input'); titleInput.className = 'input'; titleInput.value = item.title || '';
          tdTitle.appendChild(titleInput);

          const tdViews = document.createElement('td'); const pillV = document.createElement('span'); pillV.className = 'pill'; pillV.textContent = (item.views || 0) + ' views'; tdViews.appendChild(pillV);

          const tdStatus = document.createElement('td'); const pillS = document.createElement('span'); pillS.className = 'pill ' + (item.published === false ? '' : 'pub'); pillS.textContent = item.published === false ? 'Non pubblicato' : 'Pubblicato'; tdStatus.appendChild(pillS);

          const tdActions = document.createElement('td'); const actions = document.createElement('div'); actions.className = 'actions';
          const btnSave = document.createElement('button'); btnSave.className = 'btn'; btnSave.textContent = 'üíæ Salva';
          const btnReset = document.createElement('button'); btnReset.className = 'btn'; btnReset.textContent = 'üîÑ Reset';
          const btnToggle = document.createElement('button'); btnToggle.className = 'btn'; btnToggle.textContent = item.published === false ? 'üì¢ Pubblica' : 'üôà Nascondi';
          const btnDel = document.createElement('button'); btnDel.className = 'btn danger'; btnDel.textContent = 'üóëÔ∏è Elimina';
          actions.append(btnSave, btnReset, btnToggle, btnDel); tdActions.appendChild(actions);

          tr.append(tdPrev, tdTitle, tdViews, tdStatus, tdActions);
          adminBody.appendChild(tr);

          btnSave.addEventListener('click', () => {
            const s = getSaved(); s[idx].title = titleInput.value.trim(); setSaved(s); renderAdminTable(); renderAll(); showStatus('Titolo aggiornato', 'success'); setTimeout(()=>showStatus(''), 900);
          });

          btnReset.addEventListener('click', () => {
            if(!confirm('Resetta le views a 0 per questo video?')) return;
            const s = getSaved(); s[idx].views = 0; setSaved(s); renderAdminTable(); renderAll(); showStatus('Views resettate', 'success'); setTimeout(()=>showStatus(''), 900);
          });

          btnToggle.addEventListener('click', () => {
            const s = getSaved(); s[idx].published = !(s[idx].published === false); setSaved(s); renderAdminTable(); renderAll(); showStatus(s[idx].published ? 'Video pubblicato' : 'Video nascosto', 'success'); setTimeout(()=>showStatus(''), 900);
          });

          btnDel.addEventListener('click', () => {
            if(!confirm("Sei sicuro di eliminare questo video dall'indice locale?")) return;
            const s = getSaved(); s.splice(idx,1); setSaved(s); renderAdminTable(); renderAll(); showStatus('Video eliminato', 'error'); setTimeout(()=>showStatus(''), 1200);
          });
        });
      }
      window.renderAdminTable = renderAdminTable;
      adminToVideo && adminToVideo.addEventListener('click', ()=>{ videoSection.classList.remove('hidden'); adminSection.classList.add('hidden'); renderAll(); });
      adminToHome && adminToHome.addEventListener('click', ()=>{ homeSection.classList.remove('hidden'); adminSection.classList.add('hidden'); });

      /* --------- OVERLAY FULLSCREEN TOGGLE (J) ---------
         Behavior:
         - Press J: if no overlay => create overlay, mute+pause underlying active video, play overlay full-screen
         - Press J: if overlay present => remove it, restore underlying video's mute and play state and currentTime (optional)
         - You can call window.toggleOverlayVideo(url) to trigger programmatically
      --------------------------------------------------*/
      let overlayEl = null;
      let overlayVideoEl = null;
      let underlying = null;
      let underlyingState = { wasPlaying:false, muted:false, time:0 };
      adminToVideo && adminToVideo.addEventListener('click', () => { videoSection.classList.remove('hidden'); adminSection.classList.add('hidden'); renderAll(); });
      adminToHome && adminToHome.addEventListener('click', () => { homeSection.classList.remove('hidden'); adminSection.classList.add('hidden'); });

      /* ============= SEARCH filter ============= */
      searchVideos && searchVideos.addEventListener('input', () => {
        const term = (searchVideos.value || '').toLowerCase();
        document.querySelectorAll('.video-card').forEach(card => {
          const src = (card.querySelector('video')?.src || '').toLowerCase();
          const title = (card.querySelector('.title')?.textContent || '').toLowerCase();
          card.style.display = (!term || src.includes(term) || title.includes(term)) ? '' : 'none';
        });
      });

      /* ============= OVERLAY FULLSCREEN J Toggle (mute underlying) ============= */
      let overlayEl = null, overlayVideoEl = null;
      let underlying = null, underlyingState = { wasPlaying:false, muted:false, time:0 };

      function findActiveUnderlyingVideo(){
        // prefer a video that is currently playing; otherwise the first visible video
        const vids = Array.from(document.querySelectorAll('.video-card video, video')).filter(v => v.offsetParent !== null);
        if(!vids.length) return null;
        const playing = vids.find(v => !v.paused && !v.ended);
        return playing || vids[0];
      }

      function buildOverlay(url){
        removeOverlay(); // ensure single instance
        overlayEl = document.createElement('div');
        overlayEl.className = 'overlay-fullscreen';
        removeOverlay();
        overlayEl = document.createElement('div'); overlayEl.className = 'overlay-fullscreen';
        overlayVideoEl = document.createElement('video');
        overlayVideoEl.src = url;
        overlayVideoEl.controls = true;
        overlayVideoEl.autoplay = true;
        overlayVideoEl.playsInline = true;
        overlayVideoEl.style.outline = 'none';
        overlayVideoEl.setAttribute('controlsList','nodownload');
        overlayVideoEl.addEventListener('contextmenu', e => e.preventDefault());
        // pressing ESC or double-click closes overlay
        overlayVideoEl.addEventListener('dblclick', removeOverlay);
        overlayVideoEl.addEventListener('ended', removeOverlay);
        // allow exit with ESC
        function escHandler(e){
          if(e.key === 'Escape') removeOverlay();
        }
        // keep ESC to close
        function escHandler(e){ if(e.key === 'Escape') removeOverlay(); }
        document.addEventListener('keydown', escHandler);
        // attach handler removal when overlay removed
        overlayEl._escHandler = escHandler;

        overlayEl.appendChild(overlayVideoEl);
        document.body.appendChild(overlayEl);
        // prevent page scroll while overlay open
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        // focus & try play
        overlayVideoEl.focus();
        overlayVideoEl.play().catch(()=>{ /* autoplay might be blocked until user gesture */ });
        overlayVideoEl.play().catch(()=>{ /* autoplay policy may require user gesture */ });
      }

      function removeOverlay(){
        if(!overlayEl) return;
        // restore underlying state
        if(underlying){
          try{
          try {
            underlying.muted = underlyingState.muted;
            if(underlyingState.wasPlaying){
              // try resume
              underlying.currentTime = underlyingState.time || underlying.currentTime;
              underlying.play().catch(()=>{});
            }
          } catch(e){ /* ignore */ }
          } catch(e){ console.warn('restore underlying failed', e); }
          underlying = null;
        }
        // remove overlay DOM and cleanup
        try{
          document.removeEventListener('keydown', overlayEl._escHandler);
        } catch(e){}
        try{ overlayEl.remove(); } catch(e){}
        overlayEl = null;
        overlayVideoEl = null;
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        try { document.removeEventListener('keydown', overlayEl._escHandler); } catch(e){}
        try { overlayEl.remove(); } catch(e){}
        overlayEl = null; overlayVideoEl = null;
        document.documentElement.style.overflow = ''; document.body.style.overflow = '';
      }

      function toggleOverlayVideo(url){
        if(overlayEl){
          removeOverlay();
          return;
        }
        if(overlayEl){ removeOverlay(); return; }
        const target = findActiveUnderlyingVideo();
        underlying = target;
        if(underlying){
          underlyingState.wasPlaying = !underlying.paused && !underlying.ended;
          underlyingState.muted = underlying.muted;
          underlyingState.time = underlying.currentTime || 0;
          try{ underlying.muted = true; underlying.pause(); } catch(e){}
          try { underlying.muted = true; underlying.pause(); } catch(e){}
        } else {
          underlyingState = { wasPlaying:false, muted:false, time:0 };
        }
        buildOverlay(url || FALLBACK_OVERLAY_URL);
        buildOverlay(url || (underlying && underlying.dataset && underlying.dataset.overlaySrc) || '');
      }
      window.toggleOverlayVideo = toggleOverlayVideo;

      // bind key J (case-insensitive), ignore when typing in inputs
      document.addEventListener('keydown', (e) => {
        const active = document.activeElement;
        const tag = active && active.tagName;
        const isTyping = tag === 'INPUT' || tag === 'TEXTAREA' || (active && active.isContentEditable);
        if(isTyping) return;
        if(e.key && e.key.toLowerCase() === 'j'){
          // choose overlay source:
          // - if a visible/playing underlying video has data-overlay-src, use it
          // - otherwise use the fallback
          const under = findActiveUnderlyingVideo();
          let overlaySrc = FALLBACK_OVERLAY_URL;
          if(under && under.dataset && under.dataset.overlaySrc) overlaySrc = under.dataset.overlaySrc;
          // call toggle
          let overlaySrc = (under && under.dataset && under.dataset.overlaySrc) || '';
          if(!overlaySrc){
            // fallback: use first saved video as overlay if available
            const saved = getSaved();
            overlaySrc = (saved && saved[0] && saved[0].url) || '';
          }
          if(!overlaySrc){
            showStatus('Nessun overlay disponibile', 'error'); return;
          }
          toggleOverlayVideo(overlaySrc);
        }
      });

      /* initial render */
      /* ============= initial render and diagnostics ============= */
      renderAll();
      console.info('Overlay FULLSCREEN J ready. Press J to toggle. Fallback overlay:', FALLBACK_OVERLAY_URL);
      console.info('Jiorro: init done; Cloudinary URL:', CLOUDINARY_URL, 'preset:', UPLOAD_PRESET);
      console.info('Saved videos:', getSaved());

      /* ============= DEBUG helpers (istruzioni utili) ============= */
      // Apri DevTools e cerca eventuali errori in Console o Network
      // Consigli rapidi:
      // - Assicurati che UPLOAD_PRESET sia unsigned (non richieda API key)
      // - Controlla la risposta HTTP in Network sulla chiamata a CLOUDINARY_URL
      // - Se appare errore CORS, controlla le impostazioni Cloudinary o usa server-side upload
      // - Se ricevi 401/403, controlla preset e cloud name
      // - Log importante salvato: localStorage.getItem(STORAGE_KEY)
    }); // DOMContentLoaded
  </script>
</body>
</html>
