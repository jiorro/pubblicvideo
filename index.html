<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jiorro ‚Äî Video manager</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f0f10;color:#e8eefb}
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 18px;background:#17171a;border-bottom:1px solid #2b2b30}
    .lens-btn{cursor:pointer;background:#17171a;border:1px solid #2b2b30;border-radius:8px;padding:8px;color:#e8eefb}
    .section{padding-top:80px}
    .hidden{display:none}
    .panel{background:#17171a;border:1px solid #2b2b30;border-radius:12px;padding:20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{background:#17171a;border:1px solid #2b2b30;border-radius:12px;padding:10px}
    .card video{width:100%;border-radius:8px;background:black}
    .overlay-fullscreen{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:2000}
    .overlay-fullscreen video{width:100%;height:100%;object-fit:contain}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    .modal.show{display:flex}
    .modal .panel{max-width:500px;width:90%}
  </style>
</head>
<body>
  <header class="topbar">
    <div>Jiorro ‚Äî Video manager</div>
    <button id="lensBtn" class="lens-btn">üîç</button>
  </header>

  <main id="homeSection" class="section">
    <div class="panel">
      <h1>Benvenuto</h1>
      <p>Clicca üîç per aprire la sezione video. Premi J per overlay full‚Äëscreen.</p>
    </div>
  </main>

  <section id="videoSection" class="section hidden">
    <div class="panel">
      <button id="backHome">üè† Home</button>
      <button id="openUpload">‚¨ÜÔ∏è Carica</button>
      <input id="searchVideos" placeholder="Cerca video" />
      <select id="sortSelect">
        <option value="recent">Pi√π recenti</option>
        <option value="views">Pi√π visti</option>
        <option value="title">Titolo</option>
      </select>
      <button id="diagnoseBtn">ü©∫ Diagnostica</button>
      <div id="videoContainer" class="cards"></div>
    </div>
  </section>

  <!-- Modale Upload -->
  <div id="uploadModal" class="modal">
    <div class="panel">
      <h3>Carica Video</h3>
      <input id="videoFile" type="file" accept="video/*" />
      <input id="videoTitle" placeholder="Titolo (opzionale)" />
      <button id="uploadBtn">Carica</button>
      <button id="closeUpload">Chiudi</button>
      <div id="uploadStatus"></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  console.log('JS caricato');

  const STORAGE_KEY = 'jiorroVideos_v3';
  const CLOUDINARY_CLOUD = 'dng8rjd6u'; // il tuo cloud name
  const UPLOAD_PRESET = 'nome_preset_unsigned'; // <-- metti qui il tuo preset unsigned
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;

  const lensBtn=document.getElementById('lensBtn');
  const backHome=document.getElementById('backHome');
  const homeSection=document.getElementById('homeSection');
  const videoSection=document.getElementById('videoSection');
  const videoContainer=document.getElementById('videoContainer');
  const searchVideos=document.getElementById('searchVideos');
  const sortSelect=document.getElementById('sortSelect');
  const diagnoseBtn=document.getElementById('diagnoseBtn');

  const openUploadBtn=document.getElementById('openUpload');
  const uploadModal=document.getElementById('uploadModal');
  const closeUploadBtn=document.getElementById('closeUpload');
  const uploadBtn=document.getElementById('uploadBtn');
  const fileInput=document.getElementById('videoFile');
  const titleInput=document.getElementById('videoTitle');
  const uploadStatus=document.getElementById('uploadStatus');

  function getSaved(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ return []; } }
  function setSaved(a){ localStorage.setItem(STORAGE_KEY, JSON.stringify(a)); }

  function showHome(){ homeSection.classList.remove('hidden'); videoSection.classList.add('hidden'); }
  function showVideo(){ homeSection.classList.add('hidden'); videoSection.classList.remove('hidden'); renderAll(); }

  lensBtn.addEventListener('click', showVideo);
  backHome.addEventListener('click', showHome);

  // Upload modal
  openUploadBtn.addEventListener('click', ()=>uploadModal.classList.add('show'));
  closeUploadBtn.addEventListener('click', ()=>uploadModal.classList.remove('show'));

  uploadBtn.addEventListener('click', async ()=>{
    const f=fileInput.files[0];
    if(!f){ uploadStatus.textContent='‚ùå Seleziona un file'; return; }
    try {
      const form=new FormData();
      form.append('file', f);
      form.append('upload_preset', UPLOAD_PRESET);
      const r=await fetch(CLOUDINARY_URL,{method:'POST',body:form});
      const data=await r.json();
      if(!data.secure_url){ uploadStatus.textContent='‚ùå Upload fallito'; return; }
      const saved=getSaved();
      saved.unshift({url:data.secure_url,title:(titleInput.value||f.name),views:0,published:true,uploadedAt:Date.now()});
      setSaved(saved);
      renderAll();
      uploadStatus.textContent='‚úÖ Caricato su Cloudinary';
      setTimeout(()=>uploadModal.classList.remove('show'),1000);
    } catch(e){
      console.error(e);
      uploadStatus.textContent='‚ùå Errore upload';
    }
  });

  function tryMp4(url){
    if(!url) return url;
    if(url.endsWith('.mp4')) return url;
    if(url.includes('/video/upload/')) return url.replace('/video/upload/','/video/upload/f_mp4/').replace(/\.webm($|\?)/i,'.mp4$1');
    return url;
  }

  function createCard(item){
    const card=document.createElement('div'); card.className='card';
    const v=document.createElement('video'); v.controls=true;
    const s=document.createElement('source'); s.src=tryMp4(item.url); s.type='video/mp4';
    v.appendChild(s);
    const t=document.createElement('div'); t.textContent=item.title||'Video';
    card.appendChild(v); card.appendChild(t);
    return card;
  }

  function renderAll(){
    videoContainer.innerHTML='';
    let saved=getSaved();
    const sortBy=sortSelect.value;
    if(sortBy==='views') saved=saved.sort((a,b)=>(b.views||0)-(a.views||0));
    else if(sortBy==='title') saved=saved.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
    if(!saved.length){ videoContainer.textContent='Nessun video pubblicato.'; return; }
    saved.forEach(i=>videoContainer.appendChild(createCard(i)));
  }

  // Import da serverless
  async function loadCloudinary(){
    try{
      const r=await fetch('/api/cloudinary-list');
      const data=await r.json();
      const merged=getSaved();
      (data.items||[]).reverse().forEach(it=>{
        const candidate=tryMp4(it.url);
        if(candidate && !merged.find(m=>m.url===candidate)){
          merged.unshift({url:candidate,title:it.title||it.public_id,views:0,published:true});
        }
      });
      setSaved(merged);
      renderAll();
      console.log('Importati
