<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jiorro Video ‚Äî robust upload & admin</title>
  <style>
    :root{
      --bg:#0f0f10; --panel:#18181b; --border:#2a2a31; --text:#fff;
      --muted:#b7b7c3; --accent:#6ff66f; --brand:#66aaff; --danger:#ff6666;
      --shadow:rgba(0,0,0,0.35);
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    *{box-sizing:border-box}
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;display:flex;justify-content:space-between;align-items:center;padding:0 18px;background:#18181b;border-bottom:1px solid var(--border);z-index:1000}
    .lens-btn{cursor:pointer;background:#18181b;border:1px solid var(--border);border-radius:8px;padding:8px;color:#fff}
    .section{padding-top:80px}
    .hidden{display:none}
    .panel{background:#18181b;border:1px solid var(--border);border-radius:12px;padding:20px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{background:#18181b;border:1px solid var(--border);border-radius:12px;padding:10px}
    .card video{width:100%;border-radius:8px;background:black}
    .overlay-fullscreen{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:2000}
    .overlay-fullscreen video{width:100%;height:100%;object-fit:contain}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    .modal.show{display:flex}
    .modal .panel{max-width:500px;width:90%}
    .status{position:fixed;top:70px;right:20px;font-size:13px;color:var(--muted);z-index:950;text-align:right}
    .status.success{color:var(--accent)} .status.error{color:var(--danger)} .status.info{color:var(--brand)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202025;color:var(--muted);border:1px solid var(--border);font-size:13px;margin:2px}
  </style>
</head>
<body>
  <header class="topbar">
    <div>Jiorro Video Manager</div>
    <button id="lensBtn" class="lens-btn">üîç</button>
  </header>

  <div id="statusEl" class="status"></div>

  <!-- Home -->
  <main id="homeSection" class="section">
    <div class="panel">
      <h1>Benvenuto</h1>
      <p>Importa automaticamente i video da Cloudinary, cerca, riproduci, testa upload e usa l‚Äôoverlay full‚Äëscreen con J.</p>
      <ul style="list-style:none;padding:0;display:flex;flex-wrap:wrap">
        <li class="pill">Import automatico</li>
        <li class="pill">Runtime .webm ‚Üí .mp4</li>
        <li class="pill">Ricerca client</li>
        <li class="pill">Upload preset / fallback</li>
        <li class="pill">Diagnostica URL</li>
      </ul>
    </div>
  </main>

  <!-- Video -->
  <section id="videoSection" class="section hidden">
    <div class="panel">
      <button id="backHome">üè† Home</button>
      <button id="openUpload">‚¨ÜÔ∏è Carica</button>
      <input id="searchVideos" placeholder="Cerca video" />
      <select id="sortSelect">
        <option value="recent">Pi√π recenti</option>
        <option value="views">Pi√π visti</option>
        <option value="title">Titolo</option>
      </select>
      <button id="diagnoseBtn">ü©∫ Diagnostica</button>
      <div id="videoContainer" class="cards"></div>
    </div>
  </section>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="panel">
      <h3>Carica Video</h3>
      <input id="videoFile" type="file" accept="video/*" />
      <input id="videoTitle" placeholder="Titolo (opzionale)" />
      <button id="uploadBtn">Carica</button>
      <button id="closeUpload">Chiudi</button>
      <div id="uploadStatus"></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY='jiorroVideos_v3';
  const CLOUDINARY_CLOUD='dng8rjd6u'; // tuo cloud name
  const UPLOAD_PRESET='jiorro_upload'; // preset unsigned
  const CLOUDINARY_URL=`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;

  const lensBtn=document.getElementById('lensBtn');
  const backHome=document.getElementById('backHome');
  const homeSection=document.getElementById('homeSection');
  const videoSection=document.getElementById('videoSection');
  const videoContainer=document.getElementById('videoContainer');
  const searchVideos=document.getElementById('searchVideos');
  const sortSelect=document.getElementById('sortSelect');
  const diagnoseBtn=document.getElementById('diagnoseBtn');
  const openUploadBtn=document.getElementById('openUpload');
  const uploadModal=document.getElementById('uploadModal');
  const closeUploadBtn=document.getElementById('closeUpload');
  const uploadBtn=document.getElementById('uploadBtn');
  const fileInput=document.getElementById('videoFile');
  const titleInput=document.getElementById('videoTitle');
  const uploadStatus=document.getElementById('uploadStatus');
  const statusEl=document.getElementById('statusEl');

  function getSaved(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return[];} }
  function setSaved(a){ localStorage.setItem(STORAGE_KEY,JSON.stringify(a)); }
  function showStatus(msg,type=''){ statusEl.textContent=msg; statusEl.className='status'+(type?' '+type:''); }

  function showHome(){ homeSection.classList.remove('hidden'); videoSection.classList.add('hidden'); }
  function showVideo(){ homeSection.classList.add('hidden'); videoSection.classList.remove('hidden'); renderAll(); }

  lensBtn.addEventListener('click',showVideo);
  backHome.addEventListener('click',showHome);

  openUploadBtn.addEventListener('click',()=>uploadModal.classList.add('show'));
  closeUploadBtn.addEventListener('click',()=>uploadModal.classList.remove('show'));

  uploadBtn.addEventListener('click',async()=>{
    const f=fileInput.files[0];
    if(!f){ uploadStatus.textContent='‚ùå Seleziona un file'; return; }
    try{
      const form=new FormData();
      form.append('file',f);
      form.append('upload_preset',UPLOAD_PRESET);
      const r=await fetch(CLOUDINARY_URL,{method:'POST',body:form});
      const data=await r.json();
      if(!data.secure_url){ uploadStatus.textContent='‚ùå Upload fallito'; return; }
      const saved=getSaved();
      saved.unshift({url:data.secure_url,title
