<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jiorro Video ‚Äî Login, Upload, Admin & Overlay J</title>
  <style>
    :root{
      --bg:#0f0f10; --panel:#18181b; --border:#2a2a31; --text:#fff;
      --muted:#b7b7c3; --accent:#6ff66f; --brand:#66aaff; --danger:#ff6666;
      --shadow:rgba(0,0,0,0.35);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    *{box-sizing:border-box}
    .topbar{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:linear-gradient(to bottom, rgba(24,24,27,0.95), rgba(24,24,27,0.7));border-bottom:1px solid var(--border);z-index:1000;backdrop-filter:blur(6px)}
    .lens-btn{width:44px;height:44px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:20px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .status{position:fixed;top:70px;right:20px;font-size:13px;color:var(--muted);z-index:950;text-align:right}
    .status.success{color:var(--accent)} .status.error{color:var(--danger)} .status.info{color:var(--brand)}
    .section{padding-top:96px;min-height:100vh}
    .hidden{display:none}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 14px 36px var(--shadow)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#202025;color:var(--muted);border:1px solid var(--border);font-size:13px;margin:2px}
    .video-container{padding:28px;display:grid;gap:16px}
    .video-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px;border-radius:12px}
    .btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-2px)}
    .btn.danger{border-color:#5a1f1f;color:#ffdddd}
    .input{background:var(--panel);border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text)}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
    .card{background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:12px;box-shadow:0 10px 30px var(--shadow);display:flex;flex-direction:column;gap:8px}
    .card video{width:100%;border-radius:8px;background:black}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th, td{padding:10px;border-top:1px solid var(--border);vertical-align:middle}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .overlay-fullscreen{position:fixed;inset:0;z-index:20000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.98)}
    .overlay-fullscreen video{width:100%;height:100%;object-fit:contain;background:black}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);z-index:1200}
    .modal.show{display:flex}
    .modal-panel{width:92%;max-width:680px;background:var(--panel);border:1px solid var(--border);padding:18px;border-radius:12px;box-shadow:0 14px 44px var(--shadow)}
    .progress{height:8px;border-radius:999px;background:#111;margin-top:8px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .2s}
    .status-line{margin-top:8px;color:var(--muted);min-height:18px}
    .status-line.success{color:var(--accent)} .status-line.error{color:var(--danger)}
    .admin-anchor{position:fixed;left:12px;bottom:12px;z-index:1300;display:flex;flex-direction:column;align-items:flex-start;gap:8px}
    .admin-btn{width:44px;height:44px;border-radius:999px;background:var(--panel);border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;color:var(--text);font-size:18px;cursor:pointer}
    .admin-input-wrap{display:none;gap:8px;align-items:center}
    .admin-input{width:220px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);outline:none;caret-color:var(--text)}
    @media(max-width:980px){.admin-input{width:150px}}
  </style>
</head>
<body>
  <header class="topbar" aria-label="Navbar">
    <div>Jiorro Video Manager</div>
    <button id="lensBtn" class="lens-btn" aria-controls="videoSection" aria-expanded="false" title="Apri sezione video">üîç</button>
  </header>

  <div id="statusEl" class="status" role="status" aria-live="polite"></div>

  <!-- Login -->
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-panel" role="document">
      <h3 id="loginTitle">Accesso</h3>
      <p style="color:var(--muted)">Inserisci una passphrase sicura. Se √® la prima volta, scegli un username.</p>
      <input id="passphraseInput" class="input" placeholder="Passphrase" />
      <input id="usernameInput" class="input" placeholder="Username (se nuovo)" />
      <div class="actions" style="margin-top:10px">
        <button id="loginBtn" class="btn">Entra</button>
      </div>
      <div id="loginStatus" class="status-line" aria-live="polite"></div>
    </div>
  </div>

  <!-- Home -->
  <main id="homeSection" class="section" aria-label="Home">
    <div class="panel">
      <h1>La regione di Canaan</h1>
      <p>Importa automaticamente i video da Cloudinary, cerca, riproduci, testa upload e usa l‚Äôoverlay full‚Äëscreen con J.</p>
      <ul style="list-style:none;padding:0;display:flex;flex-wrap:wrap">
        <li class="pill">Import automatico</li>
        <li class="pill">Runtime .webm ‚Üí .mp4</li>
        <li class="pill">Ricerca client</li>
        <li class="pill">Upload preset / fallback</li>
        <li class="pill">Diagnostica URL</li>
      </ul>
    </div>
  </main>

  <!-- Video -->
  <section id="videoSection" class="section hidden" aria-label="Sezione video">
    <div class="video-container">
      <div class="video-toolbar panel" role="toolbar" aria-label="Strumenti video">
        <button id="openUpload" class="btn" aria-controls="uploadModal" aria-expanded="false">‚¨ÜÔ∏è Carica</button>
        <input id="searchVideos" class="input" placeholder="Cerca video per titolo o URL" aria-label="Cerca video" />
        <button id="backHome" class="btn">üè† Home</button>
      </div>
      <div id="videoContainer" class="cards" aria-live="polite" aria-busy="false"></div>
    </div>
  </section>

  <!-- Admin -->
  <section id="adminSection" class="section hidden" aria-label="Admin">
    <div class="panel">
      <h2>üîß Pannello amministrazione</h2>
      <p style="color:var(--muted)">Modifica titoli, resetta views, elimina, pubblica/nascondi. Analytics locali per utenti e video. Puoi bloccare/sbloccare utenti.</p>
      <table id="adminGrid">
        <thead><tr><th>Anteprima</th><th>Titolo</th><th>Views</th><th>Stato</th><th>Azioni</th></tr></thead>
        <tbody id="adminBody"></tbody>
      </table>
      <hr style="border-color:var(--border)">
      <h3>Utenti</h3>
      <table id="userGrid">
        <thead><tr><th>Viewer ID</th><th>Username</th><th>Bloccato</th><th>Azioni</th></tr></thead>
        <tbody id="userBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Upload modal -->
  <div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="modal-panel" role="document">
      <h3 id="uploadTitle">Upload Video</h3>
      <div style="margin-top:8px">
        <label for="videoFile">File</label><br>
        <input id="videoFile" type="file" accept="video/*" />
      </div>
      <div style="margin-top:8px">
        <label for="videoTitle">Titolo</label><br>
        <input id="videoTitle" class="input" placeholder="Titolo (opzionale)" />
      </div>
      <div style="margin-top:8px">
        <label for="overlaySrc">Overlay source (opzionale)</label><br>
        <input id="overlaySrc" class="input" placeholder="URL usato dal toggle J (data-overlay-src)" />
      </div>
      <div class="progress" aria-hidden="true"><i id="uploadProgress"></i></div>
      <div class="actions" style="margin-top:10px">
        <button id="uploadBtn" class="btn">Carica</button>
        <button id="closeUpload" class="btn">Chiudi</button>
      </div>
      <div id="uploadStatus" class="status-line" aria-live="polite"></div>
    </div>
  </div>

  <!-- Admin anchor -->
  <div class="admin-anchor" aria-label="Admin anchor">
    <button id="adminAnchorBtn" class="admin-btn" title="Sblocca admin">üîë</button>
    <div id="adminInputWrap" class="admin-input-wrap" aria-hidden="true">
      <input id="adminInput" class="admin-input" placeholder="Password admin" />
      <button id="adminSubmit" class="btn">Sblocca</button>
      <button id="adminToHome" class="btn">Home</button>
      <button id="adminToVideo" class="btn">Video</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Config
      const STORAGE_KEY = 'jiorroVideos_secure_v1';
      const USERS_KEY = 'jiorroUsers_v1';
      const ANALYTICS_KEY = 'jiorroAnalytics_v2';
      const SESSION_KEY = 'jiorroSession_v1';

      const CLOUDINARY_CLOUD = 'dng8rjd6u';
      const UPLOAD_PRESET = 'jiorro_upload';
      const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/auto/upload`;
      const MAX_FILE_MB = 800;
      const UPLOAD_TIMEOUT_MS = 3 * 60 * 1000;

      const VIDEO_J_DEFAULT = 'https://res.cloudinary.com/demo/video/upload/sample.mp4';

      // Admin offuscato
      const ADMIN_HASH = '7d3f6f4e87b2d8c9b4f0a1be4b69a2b1'; // sostituisci con tuo hash forte
      const PEPPER = 'X2f!_jR9';

      // DOM refs
      const statusEl = document.getElementById('statusEl');
      const lensBtn = document.getElementById('lensBtn');
      const homeSection = document.getElementById('homeSection');
      const videoSection = document.getElementById('videoSection');
      const adminSection = document.getElementById('adminSection');
      const backHome = document.getElementById('backHome');
      const videoContainer = document.getElementById('videoContainer');
      const searchVideos = document.getElementById('searchVideos');

      const loginModal = document.getElementById('loginModal');
      const passphraseInput = document.getElementById('passphraseInput');
      const usernameInput = document.getElementById('usernameInput');
      const loginBtn = document.getElementById('loginBtn');
      const loginStatus = document.getElementById('loginStatus');

      const openUploadBtn = document.getElementById('openUpload');
      const uploadModal = document.getElementById('uploadModal');
      const closeUploadBtn = document.getElementById('closeUpload');
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('videoFile');
      const titleInput = document.getElementById('videoTitle');
      const overlaySrcInput = document.getElementById('overlaySrc');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadProgress = document.getElementById('uploadProgress');

      const adminAnchorBtn = document.getElementById('adminAnchorBtn');
      const adminInputWrap = document.getElementById('adminInputWrap');
      const adminInput = document.getElementById('adminInput');
      const adminSubmit = document.getElementById('adminSubmit');
      const adminBody = document.getElementById('adminBody');
      const userBody = document.getElementById('userBody');
      const adminToVideo = document.getElementById('adminToVideo');
      const adminToHome = document.getElementById('adminToHome');

      // Helpers
      function showStatus(msg, type){ statusEl.textContent = msg || ''; statusEl.className = 'status' + (type ? ' ' + type : ''); }
      function getSaved(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch(e){ return []; } }
      function setSaved(a){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(a||[])); } catch(e){} }
      function getUsers(){ try { return JSON.parse(localStorage.getItem(USERS_KEY)||'{}'); } catch(e){ return {}; } }
      function setUsers(u){ try { localStorage.setItem(USERS_KEY, JSON.stringify(u||{})); } catch(e){} }
      function getAnalytics(){ try { return JSON.parse(localStorage.getItem(ANALYTICS_KEY) || '{"events":[],"counters":{}}'); } catch(e){ return { events:[], counters:{} }; } }
      function setAnalytics(a){ try { localStorage.setItem(ANALYTICS_KEY, JSON.stringify(a || { events:[], counters:{} })); } catch(e){} }
      function getSession(){ try { return JSON.parse(localStorage.getItem(SESSION_KEY)||'{}'); } catch(e){ return {}; } }
      function setSession(s){ try { localStorage.setItem(SESSION_KEY, JSON.stringify(s||{})); } catch(e){} }

      async function subtleHash(s){
        const enc = new TextEncoder().encode(s);
        const buf = await crypto.subtle.digest('SHA-256', enc);
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }

      // Track
      function track(type, payload={}){
        const sess = getSession();
        const viewerId = sess.viewerId || 'anon';
        const username = sess.username || null;
        const a = getAnalytics();
        const evt = { ts: Date.now(), type, viewerId, username, payload };
        a.events.push(evt);
        if(payload.url){
          a.counters[payload.url] = a.counters[payload.url] || { plays:0, overlays:0, viewers:{} };
          if(type === 'video_play') a.counters[payload.url].plays++;
          if(type === 'overlay_open') a.counters[payload.url].overlays++;
          const key = username || viewerId;
          a.counters[payload.url].viewers[key] = (a.counters[payload.url].viewers[key] || 0) + 1;
        }
        setAnalytics(a);
      }

      // Login flow
      function isPassphraseStrong(p){
        // requisiti tipo "password Google": 12+ char, maiuscole, minuscole, numeri, simboli
        const lengthOK = p.length >= 12;
        const upper = /[A-Z]/.test(p);
        const lower = /[a-z]/.test(p);
        const digit = /[0-9]/.test(p);
        const symbol = /[^A-Za-z0-9]/.test(p);
        return lengthOK && upper && lower && digit && symbol;
      }

      function genViewerId(){
        const rand = crypto.getRandomValues(new Uint8Array(16));
        return Array.from(rand).map(b=>b.toString(16).padStart(2,'0')).join('');
      }

      async function ensureLogin(){
        const sess = getSession();
        const users = getUsers();

        // Se blocco esiste per viewerId/username, impedisci accesso
        if(sess.viewerId && users[sess.viewerId]?.blocked){ showStatus('Accesso bloccato', 'error'); return false; }

        // Se sessione gi√† valida, ok
        if(sess.viewerId && sess.token){ return true; }

        // Altrimenti mostra login
        loginModal.classList.add('show');
        return false;
      }

      loginBtn.addEventListener('click', async () => {
        const phrase = (passphraseInput.value||'').trim();
        const uname = (usernameInput.value||'').trim();

        if(!isPassphraseStrong(phrase)){ loginStatus.textContent='‚ùå Passphrase debole: usa 12+ caratteri con maiuscole, minuscole, numeri e simboli'; return; }

        const viewerId = genViewerId();
        const token = await subtleHash(phrase + viewerId + PEPPER);

        // Persisti username (riuso se gi√† presente)
        const users = getUsers();
        const finalUsername = uname || users[viewerId]?.username || `user_${viewerId.slice(0,6)}`;
        users[viewerId] = users[viewerId] || { username: finalUsername, blocked: false, createdAt: Date.now() };
        setUsers(users);

        setSession({ viewerId, token, username: finalUsername, ts: Date.now() });
        loginStatus.textContent='‚úÖ Accesso eseguito';
        setTimeout(()=>loginModal.classList.remove('show'), 600);
        showStatus(`Benvenuto, ${finalUsername}`, 'success');
      });

      // Navigation
      function showHome(){ homeSection.classList.remove('hidden'); videoSection.classList.add('hidden'); adminSection.classList.add('hidden'); showStatus('',''); lensBtn.setAttribute('aria-expanded','false'); }
      function showVideo(){ homeSection.classList.add('hidden'); adminSection.classList.add('hidden'); videoSection.classList.remove('hidden'); showStatus('‚úÖ Sezione video aperta','success'); setTimeout(()=>showStatus(''),900); lensBtn.setAttribute('aria-expanded','true'); renderAll(); }
      function showAdmin(){ homeSection.classList.add('hidden'); videoSection.classList.add('hidden'); adminSection.classList.remove('hidden'); showStatus('üîß Admin sbloccato','success'); setTimeout(()=>showStatus(''),900); renderAdminTables(); }

      lensBtn.addEventListener('click', async () => { const ok = await ensureLogin(); if(ok) showVideo(); });
      backHome && backHome.addEventListener('click', showHome);

      // Upload
      function openUpload(){ uploadModal.classList.add('show'); openUploadBtn && openUploadBtn.setAttribute('aria-expanded','true'); }
      function closeUpload(){ uploadModal.classList.remove('show'); openUploadBtn && openUploadBtn.setAttribute('aria-expanded','false'); uploadStatus.textContent=''; uploadProgress.style.width='0%'; fileInput.value=''; titleInput.value=''; overlaySrcInput.value=''; }
      openUploadBtn && openUploadBtn.addEventListener('click', async ()=>{ const ok = await ensureLogin(); if(ok) openUpload(); });
      closeUploadBtn && closeUploadBtn.addEventListener('click', closeUpload);

      function tryMp4(url){
        if(!url) return url;
        if(url.endsWith('.mp4')) return url;
        if(url.includes('/video/upload/')) return url.replace('/video/upload/','/video/upload/f_mp4/').replace(/\.webm($|\?)/i,'.mp4$1');
        return url;
      }

      function createCard(item){
        const card = document.createElement('div'); card.className = 'card video-card';
        const v = document.createElement('video');
        v.src = tryMp4(item.url);
        v.controls = true; v.preload = 'metadata'; v.setAttribute('controlsList','nodownload');
        v.addEventListener('contextmenu', e => e.preventDefault());
        if(item.overlaySrc) v.dataset.overlaySrc = item.overlaySrc;

        const t = document.createElement('div'); t.className='title'; t.textContent = item.title || 'Video senza titolo';
        const vw = document.createElement('div'); vw.className='views'; vw.textContent = 'üëÅÔ∏è ' + (item.views || 0) + ' views';

        let counted = false;
        v.addEventListener('play', () => {
          // Se utente bloccato, impedisci
          const sess = getSession(); const users = getUsers();
          if(sess.viewerId && users[sess.viewerId]?.blocked){ v.pause(); showStatus('Utente bloccato: visione negata', 'error'); return; }

          if (counted) return; counted = true;
          const saved = getSaved().map(s => { if (s.url === item.url) s.views = (s.views || 0) + 1; return s; });
          setSaved(saved);
          const updated = saved.find(s => s.url === item.url);
          vw.textContent = 'üëÅÔ∏è ' + ((updated && updated.views) || 0) + ' views';
          track('video_play', { url: item.url, title: item.title || null });
          if (typeof window.renderAdminTables === 'function') window.renderAdminTables();
        });

        card.append(v,t,vw);
        return card;
      }

      function renderAll(){
        if(!videoContainer) return;
        videoContainer.innerHTML='';
        const saved = getSaved().filter(v => v.published !== false).sort((a,b) => (b.views || 0) - (a.views || 0));
        if(!saved.length){ const info = document.createElement('div'); info.style.color='var(--muted)'; info.textContent='Nessun video pubblicato. Carica un video per iniziare.'; videoContainer.appendChild(info); return; }
        saved.forEach(i => videoContainer.appendChild(createCard(i)));
      }

      searchVideos && searchVideos.addEventListener('input', () => {
        const term = (searchVideos.value || '').toLowerCase();
        track('search', { term });
        document.querySelectorAll('.video-card').forEach(card => {
          const src = (card.querySelector('video')?.src || '').toLowerCase();
          const title = (card.querySelector('.title')?.textContent || '').toLowerCase();
          card.style.display = (!term || src.includes(term) || title.includes(term)) ? '' : 'none';
        });
      });

      // Upload (XHR per progress)
      function humanFileSize(bytes){
        const thresh = 1024;
        if(Math.abs(bytes) < thresh) return bytes + ' B';
        const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
        let u = -1;
        do { bytes /= thresh; ++u; } while(Math.abs(bytes) >= thresh && u < units.length - 1);
        return bytes.toFixed(1) + ' ' + units[u];
      }

      function uploadToCloudinaryXHR(file, title, onProgress){
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', UPLOAD_PRESET);
        form.append('context', `caption=${title || ''}`);
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('POST', CLOUDINARY_URL);
          xhr.timeout = UPLOAD_TIMEOUT_MS;
          xhr.onload = () => {
            if(xhr.status >= 200 && xhr.status < 300){
              try { resolve(JSON.parse(xhr.responseText)); } catch(e){ reject(e); }
            } else {
              try { const err = JSON.parse(xhr.responseText); reject(new Error(err?.error?.message || 'upload-failed')); } catch(e){ reject(new Error('upload-failed')); }
            }
          };
          xhr.onerror = () => reject(new Error('network-error'));
          xhr.ontimeout = () => reject(new Error('timeout'));
          xhr.upload.onprogress = ev => {
            if(ev.lengthComputable && typeof onProgress === 'function'){
              onProgress(Math.round(ev.loaded / ev.total * 100), ev.loaded, ev.total);
            }
          };
          xhr.send(form);
        });
      }

      uploadBtn && uploadBtn.addEventListener('click', async () => {
        const file = fileInput.files && fileInput.files[0];
        const title = (titleInput.value || '').trim();
        const overlaySrc = (overlaySrcInput.value || '').trim() || null;

        if(!file || !file.type.startsWith('video/')){ uploadStatus.textContent='‚ùå Seleziona un file video valido'; return; }
        const sizeMb = (file.size / (1024*1024)).toFixed(1);
        if(sizeMb > MAX_FILE_MB){ uploadStatus.textContent = `‚ùå File troppo grande: ${sizeMb} MB (limite locale ${MAX_FILE_MB} MB)`; return; }

        uploadStatus.textContent=`‚è≥ Caricamento ${humanFileSize(file.size)}...`;
        uploadProgress.style.width='0%'; uploadProgress.parentElement.setAttribute('aria-hidden','false');

        try{
          const data = await uploadToCloudinaryXHR(file, title, pct => {
            uploadProgress.style.width = pct + '%';
            uploadStatus.textContent = `‚è≥ ${pct}%`;
          });
          const url = data.secure_url;
          if(!url){ uploadStatus.textContent='‚ùå Nessun URL ricevuto'; return; }

          const saved = getSaved();
          saved.unshift({ url, title, overlaySrc, views:0, published:true, uploadedAt: Date.now(), cloudId: data.public_id });
          setSaved(saved);

          uploadStatus.textContent='‚úÖ Caricato su Cloudinary'; uploadProgress.style.width='100%';
          track('upload_success', { url, title });
          setTimeout(() => { closeUpload(); renderAll(); }, 600);
        }catch(err){
          console.error(err);
          uploadStatus.textContent='‚ùå Upload fallito';
          track('upload_error', { message: err?.message || String(err) });
        }
      });

      // Admin unlock (hash + pepper)
      adminAnchorBtn.addEventListener('click', () => {
        const open = adminInputWrap.style.display === 'flex';
        if(open){ adminInputWrap.style.display='none'; adminInputWrap.setAttribute('aria-hidden','true'); adminInput.value=''; }
        else { adminInputWrap.style.display='flex'; adminInputWrap.setAttribute('aria-hidden','false'); adminInput.focus(); adminInput.select(); }
      });

      adminSubmit.addEventListener('click', async () => {
        const v = (adminInput.value || '').trim();
        if(!v){ adminInput.focus(); return; }
        const candidate = await subtleHash(v + PEPPER);
        if(candidate === ADMIN_HASH){
          adminInput.value=''; showAdmin();
        } else {
          adminInput.style.transition='transform .12s';
          adminInput.style.transform='translateX(-6px)';
          setTimeout(()=>adminInput.style.transform='translateX(6px)',120);
          setTimeout(()=>adminInput.style.transform='',240);
        }
      });

      adminToVideo && adminToVideo.addEventListener('click', ()=>{ videoSection.classList.remove('hidden'); adminSection.classList.add('hidden'); renderAll(); });
      adminToHome && adminToHome.addEventListener('click', ()=>{ homeSection.classList.remove('hidden'); adminSection.classList.add('hidden'); });

      // Admin tables
      function renderAdminTables(){
        // Videos
        adminBody.innerHTML='';
        const saved = getSaved();
        if(!saved.length){
          const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=5; td.textContent='Nessun video salvato.'; td.style.color='var(--muted)';
          tr.appendChild(td); adminBody.appendChild(tr);
        } else {
          saved.forEach((item, idx) => {
            const tr = document.createElement('tr');

            const tdPrev = document.createElement('td');
            const prevV = document.createElement('video'); prevV.src=item.url; prevV.preload='metadata'; prevV.controls=true; prevV.style.maxWidth='160px'; prevV.setAttribute('controlsList','nodownload'); prevV.addEventListener('contextmenu', e=>e.preventDefault());
            if(item.overlaySrc) prevV.dataset.overlaySrc=item.overlaySrc; tdPrev.appendChild(prevV);

            const tdTitle = document.createElement('td'); const titleInputEl = document.createElement('input'); titleInputEl.className='input'; titleInputEl.value=item.title||''; tdTitle.appendChild(titleInputEl);

            const tdViews = document.createElement('td'); const pillV = document.createElement('span'); pillV.className='pill'; pillV.textContent=(item.views||0)+' views'; tdViews.appendChild(pillV);

            const tdStatus = document.createElement('td'); const pillS = document.createElement('span'); pillS.className='pill '+(item.published===false?'':'pub'); pillS.textContent = item.published===false ? 'Non pubblicato' : 'Pubblicato'; tdStatus.appendChild(pillS);

            const tdActions = document.createElement('td'); const actions = document.createElement('div'); actions.className='actions';
            const btnSave=document.createElement('button');btnSave.className='btn';btnSave.textContent='üíæ Salva';
            const btnReset=document.createElement('button');btnReset.className='btn';btnReset.textContent='üîÑ Reset';
            const btnToggle=document.createElement('button');btnToggle.className='btn';btnToggle.textContent=item.published===false?'üì¢ Pubblica':'üôà Nascondi';
            const btnDel=document.createElement('button');btnDel.className='btn danger';btnDel.textContent='üóëÔ∏è Elimina';
            actions.append(btnSave,btnReset,btnToggle,btnDel); tdActions.appendChild(actions);

            tr.append(tdPrev,tdTitle,tdViews,tdStatus,tdActions); adminBody.appendChild(tr);

            btnSave.addEventListener('click', () => { const s=getSaved(); s[idx].title=titleInputEl.value.trim(); setSaved(s); renderAdminTables(); renderAll(); showStatus('Titolo aggiornato','success'); setTimeout(()=>showStatus(''),900); });
            btnReset.addEventListener('click', () => { if(!confirm('Resetta le views a 0 per questo video?')) return; const s=getSaved(); s[idx].views=0; setSaved(s); renderAdminTables(); renderAll(); showStatus('Views resettate','success'); setTimeout(()=>showStatus(''),900); });
            btnToggle.addEventListener('click', () => { const s=getSaved(); s[idx].published=!(s[idx].published===false); setSaved(s); renderAdminTables(); renderAll(); showStatus(s[idx].published ? 'Video pubblicato':'Video nascosto','success'); setTimeout(()=>showStatus(''),900); });
            btnDel.addEventListener('click', () => { if(!confirm("Sei sicuro di eliminare questo video dall'indice locale?")) return; const s=getSaved(); s.splice(idx,1); setSaved(s); renderAdminTables(); renderAll(); showStatus('Video eliminato','error'); setTimeout(()=>showStatus(''),1200); });
          });
        }

        // Users
        userBody.innerHTML='';
        const users = getUsers();
        const entries = Object.entries(users);
        if(!entries.length){
          const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=4; td.textContent='Nessun utente registrato.'; td.style.color='var(--muted)';
          tr.appendChild(td); userBody.appendChild(tr);
        } else {
          entries.forEach(([viewerId, info])=>{
            const tr = document.createElement('tr');
            const tdId = document.createElement('td'); tdId.textContent = viewerId;
            const tdU = document.createElement('td'); tdU.textContent = info.username || '(senza nome)';
            const tdB = document.createElement('td'); tdB.textContent = info.blocked ? 'S√¨' : 'No';
            const tdA = document.createElement('td'); const actions = document.createElement('div'); actions.className='actions';
            const btnBlock=document.createElement('button');btnBlock.className='btn';btnBlock.textContent= info.blocked ? '‚úÖ Sblocca' : 'üö´ Blocca';
            const btnDelete=document.createElement('button');btnDelete.className='btn danger';btnDelete.textContent='üóëÔ∏è Elimina';
            actions.append(btnBlock,btnDelete); tdA.appendChild(actions);
            tr.append(tdId,tdU,tdB,tdA); userBody.appendChild(tr);

            btnBlock.addEventListener('click', () => {
              const u=getUsers(); u[viewerId].blocked = !u[viewerId].blocked; setUsers(u); renderAdminTables(); showStatus(u[viewerId].blocked ? 'Utente bloccato' : 'Utente sbloccato', u[viewerId].blocked ? 'error':'success');
            });
            btnDelete.addEventListener('click', () => {
              if(!confirm('Eliminare questo utente dal registro locale?')) return;
              const u=getUsers(); delete u[viewerId]; setUsers(u); renderAdminTables(); showStatus('Utente eliminato', 'error');
            });
          });
        }
      }
      window.renderAdminTables = renderAdminTables;

      // Overlay J
      let overlayEl=null, overlayVideoEl=null;
      let underlying=null, underlyingState={ wasPlaying:false, muted:false, time:0 };

      function findActiveUnderlyingVideo(){
        const vids = Array.from(document.querySelectorAll('.video-card video, video')).filter(v => v.offsetParent !== null);
        const playing = vids.find(v => !v.paused && !v.ended);
        return playing || vids[0] || null;
      }

      function buildOverlay(url){
        removeOverlay();
        overlayEl = document.createElement('div'); overlayEl.className = 'overlay-fullscreen';
        overlayVideoEl = document.createElement('video');
        overlayVideoEl.src = url; overlayVideoEl.controls = true; overlayVideoEl.autoplay = true; overlayVideoEl.playsInline = true;
        overlayVideoEl.setAttribute('controlsList','nodownload'); overlayVideoEl.addEventListener('contextmenu', e => e.preventDefault());
        overlayVideoEl.addEventListener('dblclick', removeOverlay); overlayVideoEl.addEventListener('ended', removeOverlay);
        function esc(e){ if(e.key === 'Escape') removeOverlay(); } document.addEventListener('keydown', esc); overlayEl._esc = esc;
        overlayEl.appendChild(overlayVideoEl); document.body.appendChild(overlayEl);
        document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden';
        overlayVideoEl.play().catch(()=>{});
        track('overlay_open', { url });
      }

      function removeOverlay(){
        if(!overlayEl) return;
        try { document.removeEventListener('keydown', overlayEl._esc); } catch(e){}
        try { overlayEl.remove(); } catch(e){}
        overlayEl=null; overlayVideoEl=null;
        document.documentElement.style.overflow=''; document.body.style.overflow='';
        track('overlay_close', {});
        if(underlying){
          try{
            underlying.muted = underlyingState.muted;
            if(underlyingState.wasPlaying){
              underlying.currentTime = underlyingState.time || underlying.currentTime;
              underlying.play().catch(()=>{});
            }
          }catch(e){}
          underlying=null;
        }
      }

      function toggleOverlayVideo(explicitUrl){
        if(overlayEl){ removeOverlay(); return; }
        const users = getUsers(); const sess = getSession();
        if(sess.viewerId && users[sess.viewerId]?.blocked){ showStatus('Utente bloccato: overlay negato', 'error'); return; }

        const target = findActiveUnderlyingVideo();
        underlying = target;
        if(underlying){
          underlyingState = { wasPlaying: !underlying.paused && !underlying.ended, muted: underlying.muted, time: underlying.currentTime || 0 };
          try { underlying.muted = true; underlying.pause(); } catch(e){}
        } else {
          underlyingState = { wasPlaying:false, muted:false, time:0 };
        }
        let src = (underlying && underlying.dataset && underlying.dataset.overlaySrc) || explicitUrl || VIDEO_J_DEFAULT;
        if(!src){
          const saved = getSaved();
          src = (saved[0] && saved[0].overlaySrc) || (saved[0] && saved[0].url) || VIDEO_J_DEFAULT;
        }
        if(!src){ showStatus('Nessun overlay disponibile', 'error'); return; }
        buildOverlay(src);
      }
      window.toggleOverlayVideo = toggleOverlayVideo;

      document.addEventListener('keydown', async (e) => {
        const active = document.activeElement;
        const typing = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable);
        if(typing) return;
        if(e.key && e.key.toLowerCase() === 'j'){
          const ok = await ensureLogin(); if(!ok) return;
          toggleOverlayVideo('');
        }
      });

      // Init
      (async () => {
        const ok = await ensureLogin();
        if(ok){ renderAll(); }
      })();
    });
  </script>
</body>
</html>
